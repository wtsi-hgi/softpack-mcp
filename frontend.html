<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Softpack Recipe Manager</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .stream-output {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
        }
        .stream-output .output-line { color: #333; }
        .stream-output .error-line { color: #dc2626; }
        .stream-output .start-line { color: #059669; font-weight: bold; }
        .stream-output .complete-line { color: #059669; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="softpackApp()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Softpack Recipe Manager</h1>
            <p class="text-gray-600">Manage spack recipes, install packages, and create PyPI recipes</p>
        </div>

        <!-- Session Management -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Session Management</h2>
            <div class="flex gap-4 items-center">
                <button
                    @click="createSession()"
                    :disabled="loading"
                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md transition-colors">
                    <span x-show="!loading">Create New Session</span>
                    <span x-show="loading">Creating...</span>
                </button>
                <div x-show="sessionId" class="text-sm text-gray-600">
                    Session ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded" x-text="sessionId"></span>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button
                        @click="activeTab = 'recipes'"
                        :class="activeTab === 'recipes' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        Recipe Editor
                    </button>
                    <button
                        @click="activeTab = 'install'"
                        :class="activeTab === 'install' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        Package Installation
                    </button>
                </nav>
            </div>

            <!-- Recipe Editor Tab -->
            <div x-show="activeTab === 'recipes'" class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Recipe List -->
                    <div class="lg:col-span-1">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Recipes</h3>
                            <button
                                @click="loadRecipes()"
                                :disabled="loading"
                                class="text-blue-600 hover:text-blue-700 disabled:text-gray-400 text-sm">
                                Refresh
                            </button>
                        </div>

                        <!-- Create New Recipe -->
                        <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-md">
                            <h4 class="text-sm font-medium text-gray-900 mb-3">Create New Recipe</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Package Name</label>
                                    <input
                                        x-model="newRecipeForm.package_name"
                                        @keyup.enter="createRecipe()"
                                        type="text"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="e.g., my-package">
                                </div>
                                <button
                                    @click="createRecipe()"
                                    :disabled="!newRecipeForm.package_name || creatingRecipe"
                                    class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <span x-show="!creatingRecipe">Create Recipe</span>
                                    <span x-show="creatingRecipe">Creating...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Create PyPI Recipe -->
                        <div class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-md">
                            <h4 class="text-sm font-medium text-gray-900 mb-3">Create PyPI Recipe</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">PyPI Package Name</label>
                                    <input
                                        x-model="pypiForm.package_name"
                                        @keyup.enter="createPypiRecipe()"
                                        type="text"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="e.g., requests">
                                </div>
                                <button
                                    @click="createPypiRecipe()"
                                    :disabled="!pypiForm.package_name || creatingPypi"
                                    class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <span x-show="!creatingPypi">Create PyPI Recipe</span>
                                    <span x-show="creatingPypi">Creating...</span>
                                </button>
                            </div>

                            <!-- PyPI Creation Result -->
                            <div x-show="pypiResult" class="mt-3">
                                <div :class="pypiResult && pypiResult.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
                                     class="p-3 border rounded-md text-xs">
                                    <div class="font-medium" :class="pypiResult && pypiResult.success ? 'text-green-800' : 'text-red-800'">
                                        <span x-show="pypiResult && pypiResult.success">✓ PyPI Recipe Created</span>
                                        <span x-show="pypiResult && !pypiResult.success">✗ Creation Failed</span>
                                    </div>
                                    <div class="text-gray-600 mt-1" x-text="pypiResult.message"></div>
                                    <div x-show="pypiResult.moved_to" class="text-green-700 mt-1" x-text="`Moved to: ${pypiResult.moved_to}`"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Copy Existing Package -->
                        <div class="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-md">
                            <h4 class="text-sm font-medium text-gray-900 mb-3">Copy Existing Package</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Package Name</label>
                                    <input
                                        x-model="copyForm.package_name"
                                        @keyup.enter="copyPackage()"
                                        type="text"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="e.g., zlib">
                                </div>
                                <button
                                    @click="copyPackage()"
                                    :disabled="!copyForm.package_name || copyingPackage"
                                    class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <span x-show="!copyingPackage">Copy Package</span>
                                    <span x-show="copyingPackage">Copying...</span>
                                </button>
                            </div>

                            <!-- Copy Package Result -->
                            <div x-show="copyResult" class="mt-3">
                                <div :class="copyResult && copyResult.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
                                     class="p-3 border rounded-md text-xs">
                                    <div class="font-medium" :class="copyResult && copyResult.success ? 'text-green-800' : 'text-red-800'">
                                        <span x-show="copyResult && copyResult.success">✓ Package Copied</span>
                                        <span x-show="copyResult && !copyResult.success">✗ Copy Failed</span>
                                    </div>
                                    <div class="text-gray-600 mt-1" x-text="copyResult.message"></div>
                                    <div x-show="copyResult.source_path" class="text-blue-700 mt-1" x-text="`Source: ${copyResult.source_path}`"></div>
                                    <div x-show="copyResult.destination_path" class="text-green-700 mt-1" x-text="`Destination: ${copyResult.destination_path}`"></div>
                                    <div x-show="copyResult.copy_details && copyResult.copy_details.legacy_commit" class="text-blue-700 mt-1" x-text="`Legacy Commit: ${copyResult.copy_details.legacy_commit}`"></div>
                                    <div x-show="copyResult.copy_details && copyResult.copy_details.patch_files && copyResult.copy_details.patch_files.length > 0" class="text-purple-700 mt-1">
                                        <span x-text="`Patches: ${copyResult.copy_details.patch_files.join(', ')}`"></span>
                                    </div>
                                    <div x-show="copyResult.copy_details && copyResult.copy_details.modifications_applied && copyResult.copy_details.modifications_applied.length > 0" class="text-gray-600 mt-1">
                                        <span class="font-medium">Modifications:</span>
                                        <ul class="mt-1 space-y-1">
                                            <template x-for="mod in copyResult.copy_details.modifications_applied" :key="mod">
                                                <li class="text-xs" x-text="`• ${mod.replace(/_/g, ' ')}`"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="recipe in recipes" :key="recipe.package_name">
                                <div
                                    @click="selectRecipe(recipe)"
                                    :class="selectedRecipe?.package_name === recipe.package_name ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'"
                                    class="p-3 border rounded-md cursor-pointer hover:bg-gray-100 transition-colors">
                                    <div class="font-medium text-gray-900" x-text="recipe.package_name"></div>
                                    <div class="text-sm text-gray-500" x-text="recipe.file_path"></div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        <span x-show="recipe.exists">✓ Exists</span>
                                        <span x-show="!recipe.exists">✗ Missing</span>
                                        <span x-show="recipe.size" x-text="` • ${(recipe.size / 1024).toFixed(1)} KB`"></span>
                                    </div>
                                </div>
                            </template>
                            <div x-show="recipes.length === 0" class="text-gray-500 text-center py-4">
                                No recipes found
                            </div>
                        </div>
                    </div>

                    <!-- Recipe Editor -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                Recipe Editor
                                <span x-show="selectedRecipe" x-text="`- ${selectedRecipe.package_name}`" class="text-gray-500"></span>
                            </h3>
                            <div class="flex gap-2">
                                <button
                                    @click="validateRecipe()"
                                    :disabled="!selectedRecipe || !recipeContent"
                                    class="bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm transition-colors">
                                    Validate
                                </button>
                                <button
                                    @click="saveRecipe()"
                                    :disabled="!selectedRecipe || !recipeContent || saving"
                                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <span x-show="!saving">Save</span>
                                    <span x-show="saving">Saving...</span>
                                </button>
                            </div>
                        </div>

                        <div x-show="!selectedRecipe" class="text-gray-500 text-center py-8">
                            Select a recipe from the list to edit
                        </div>

                        <div x-show="selectedRecipe">
                            <textarea
                                x-model="recipeContent"
                                class="w-full h-96 p-4 border border-gray-300 rounded-md code-editor resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Recipe content will appear here..."></textarea>

                            <!-- Validation Results -->
                            <div x-show="validationResult" class="mt-4">
                                <div :class="validationResult && validationResult.is_valid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
                                     class="p-4 border rounded-md">
                                    <div class="font-medium" :class="validationResult && validationResult.is_valid ? 'text-green-800' : 'text-red-800'">
                                        <span x-show="validationResult && validationResult.is_valid">✓ Valid Recipe</span>
                                        <span x-show="validationResult && !validationResult.is_valid">✗ Invalid Recipe</span>
                                    </div>
                                    <div x-show="validationResult.errors && validationResult.errors.length > 0" class="mt-2">
                                        <div class="text-sm font-medium text-red-800">Errors:</div>
                                        <ul class="text-sm text-red-700 mt-1 space-y-1">
                                            <template x-for="error in validationResult.errors" :key="error">
                                                <li x-text="error"></li>
                                            </template>
                                        </ul>
                                    </div>
                                    <div x-show="validationResult.warnings && validationResult.warnings.length > 0" class="mt-2">
                                        <div class="text-sm font-medium text-yellow-800">Warnings:</div>
                                        <ul class="text-sm text-yellow-700 mt-1 space-y-1">
                                            <template x-for="warning in validationResult.warnings" :key="warning">
                                                <li x-text="warning"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Package Installation Tab -->
            <div x-show="activeTab === 'install'" class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Installation Form -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Install Package</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Package Name</label>
                                <input
                                    x-model="installForm.package_name"
                                    type="text"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="e.g., zlib">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Version (optional)</label>
                                <input
                                    x-model="installForm.version"
                                    type="text"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="e.g., 1.2.13">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Variants (comma-separated)</label>
                                <input
                                    x-model="installForm.variants"
                                    type="text"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="e.g., +shared, +optimizations">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dependencies (comma-separated)</label>
                                <input
                                    x-model="installForm.dependencies"
                                    type="text"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="e.g., zlib, openssl">
                            </div>
                            <button
                                @click="installPackage()"
                                :disabled="!installForm.package_name || installing"
                                class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-2 px-4 rounded-md transition-colors">
                                <span x-show="!installing">Install Package</span>
                                <span x-show="installing">Installing...</span>
                            </button>
                        </div>
                    </div>

                    <!-- Installation Output -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Installation Output</h3>
                            <button
                                @click="clearInstallOutput()"
                                class="text-gray-500 hover:text-gray-700 text-sm">
                                Clear
                            </button>
                        </div>
                        <div class="bg-gray-900 text-gray-100 p-4 rounded-md stream-output">
                            <template x-for="(line, index) in installOutput" :key="index">
                                <div :class="getOutputLineClass(line)" x-text="line.data"></div>
                            </template>
                            <div x-show="installOutput.length === 0" class="text-gray-400">
                                Installation output will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div x-show="notification.show"
             :class="notification.type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
             class="fixed top-4 right-4 p-4 border rounded-md shadow-lg max-w-md z-50">
            <div class="flex items-center">
                <div :class="notification.type === 'success' ? 'text-green-800' : 'text-red-800'" x-text="notification.message"></div>
                <button @click="notification.show = false" class="ml-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        function softpackApp() {
            return {
                // State
                activeTab: 'recipes',
                sessionId: null,
                loading: false,
                saving: false,
                installing: false,
                creatingPypi: false,
                copyingPackage: false,

                // Recipe management
                recipes: [],
                selectedRecipe: null,
                recipeContent: '',
                validationResult: null,
                creatingRecipe: false,
                newRecipeForm: {
                    package_name: ''
                },

                // Installation
                installForm: {
                    package_name: '',
                    version: '',
                    variants: '',
                    dependencies: ''
                },
                installOutput: [],

                // PyPI creation
                pypiForm: {
                    package_name: ''
                },
                pypiResult: null,

                // Copy package
                copyForm: {
                    package_name: ''
                },
                copyResult: null,

                // Notifications
                notification: {
                    show: false,
                    type: 'success',
                    message: ''
                },

                // API base URL
                apiBase: 'http://localhost:8000',

                // Methods
                async createSession() {
                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiBase}/sessions/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.sessionId = data.session_id;
                            this.showNotification('success', `Session created: ${data.session_id}`);
                            await this.loadRecipes();
                        } else {
                            throw new Error('Failed to create session');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to create session: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadRecipes() {
                    if (!this.sessionId) return;

                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiBase}/recipes/${this.sessionId}`);

                        if (response.ok) {
                            const data = await response.json();
                            this.recipes = data.recipes;
                        } else {
                            throw new Error('Failed to load recipes');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to load recipes: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },

                async createRecipe() {
                    if (!this.newRecipeForm.package_name || !this.sessionId) {
                        console.log('Missing required data:', {
                            package_name: this.newRecipeForm.package_name,
                            session_id: this.sessionId
                        });
                        this.showNotification('error', 'Please create a session first and enter a package name');
                        return;
                    }

                    // Basic validation for package name
                    const packageName = this.newRecipeForm.package_name.trim();
                    console.log('Creating recipe for package:', packageName);

                    if (!packageName) {
                        this.showNotification('error', 'Package name cannot be empty');
                        return;
                    }

                    // Check for basic spack package name format (alphanumeric, hyphens, underscores)
                    if (!/^[a-zA-Z0-9\-_]+$/.test(packageName)) {
                        console.log('Package name validation failed for:', packageName);
                        this.showNotification('error', 'Package name can only contain letters, numbers, hyphens, and underscores');
                        return;
                    }

                    console.log('Package name validation passed, proceeding with creation...');

                    this.creatingRecipe = true;
                    try {
                        const url = `${this.apiBase}/recipes/${this.sessionId}/${packageName}/create`;
                        console.log('Making API call to:', url);

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('Recipe creation successful:', data);
                            this.showNotification('success', data.message);
                            this.newRecipeForm.package_name = ''; // Clear the form
                            await this.loadRecipes(); // Refresh the recipe list

                            // Try to select the newly created recipe
                            const newRecipe = this.recipes.find(r => r.package_name === packageName);
                            if (newRecipe) {
                                await this.selectRecipe(newRecipe);
                            }
                        } else {
                            const errorData = await response.json();
                            console.error('Recipe creation failed:', errorData);
                            throw new Error(errorData.detail || 'Failed to create recipe');
                        }
                    } catch (error) {
                        console.error('Recipe creation error:', error);
                        this.showNotification('error', `Failed to create recipe: ${error.message}`);
                    } finally {
                        this.creatingRecipe = false;
                    }
                },

                async selectRecipe(recipe) {
                    this.selectedRecipe = recipe;
                    this.validationResult = null;

                    if (recipe.exists) {
                        try {
                            const response = await fetch(`${this.apiBase}/recipes/${this.sessionId}/${recipe.package_name}`);

                            if (response.ok) {
                                const data = await response.json();
                                this.recipeContent = data.content;
                            } else {
                                throw new Error('Failed to load recipe content');
                            }
                        } catch (error) {
                            this.showNotification('error', `Failed to load recipe: ${error.message}`);
                        }
                    } else {
                        this.recipeContent = '';
                    }
                },

                async validateRecipe() {
                    if (!this.selectedRecipe || !this.recipeContent) return;

                    try {
                        const response = await fetch(`${this.apiBase}/recipes/${this.sessionId}/${this.selectedRecipe.package_name}/validate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                content: this.recipeContent,
                                package_name: this.selectedRecipe.package_name
                            })
                        });

                        if (response.ok) {
                            this.validationResult = await response.json();
                            this.showNotification(
                                this.validationResult.is_valid ? 'success' : 'error',
                                this.validationResult.is_valid ? 'Recipe is valid' : 'Recipe has errors'
                            );
                        } else {
                            throw new Error('Failed to validate recipe');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to validate recipe: ${error.message}`);
                    }
                },

                async saveRecipe() {
                    if (!this.selectedRecipe || !this.recipeContent) return;

                    this.saving = true;
                    try {
                        const response = await fetch(`${this.apiBase}/recipes/${this.sessionId}/${this.selectedRecipe.package_name}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                content: this.recipeContent,
                                description: `Updated by frontend at ${new Date().toISOString()}`
                            })
                        });

                        if (response.ok) {
                            this.showNotification('success', 'Recipe saved successfully');
                            await this.loadRecipes();
                        } else {
                            throw new Error('Failed to save recipe');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to save recipe: ${error.message}`);
                    } finally {
                        this.saving = false;
                    }
                },

                async installPackage() {
                    if (!this.installForm.package_name) return;

                    this.installing = true;
                    this.clearInstallOutput();

                    try {
                        const requestBody = {
                            package_name: this.installForm.package_name,
                            session_id: this.sessionId
                        };

                        if (this.installForm.version) {
                            requestBody.version = this.installForm.version;
                        }

                        if (this.installForm.variants) {
                            requestBody.variants = this.installForm.variants.split(',').map(v => v.trim());
                        }

                        if (this.installForm.dependencies) {
                            requestBody.dependencies = this.installForm.dependencies.split(',').map(d => d.trim());
                        }

                        const response = await fetch(`${this.apiBase}/spack/install/stream`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            const reader = response.body.getReader();
                            const decoder = new TextDecoder();

                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');

                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            this.installOutput.push(data);
                                        } catch (e) {
                                            console.error('Failed to parse SSE data:', e);
                                        }
                                    }
                                }
                            }
                        } else {
                            throw new Error('Failed to start installation');
                        }
                    } catch (error) {
                        this.showNotification('error', `Installation failed: ${error.message}`);
                        this.installOutput.push({
                            type: 'error',
                            data: `Installation failed: ${error.message}`,
                            timestamp: Date.now() / 1000
                        });
                    } finally {
                        this.installing = false;
                    }
                },

                async createPypiRecipe() {
                    if (!this.pypiForm.package_name || !this.sessionId) {
                        this.showNotification('error', 'Please create a session first and enter a PyPI package name');
                        return;
                    }

                    this.creatingPypi = true;
                    this.pypiResult = null;

                    try {
                        const response = await fetch(`${this.apiBase}/spack/create-pypi`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                package_name: this.pypiForm.package_name,
                                session_id: this.sessionId
                            })
                        });

                        if (response.ok) {
                            this.pypiResult = await response.json();
                            this.showNotification(
                                this.pypiResult.success ? 'success' : 'error',
                                this.pypiResult.message
                            );

                            if (this.pypiResult.success) {
                                // Store the package name before clearing the form
                                const packageName = this.pypiForm.package_name;

                                // Clear the form
                                this.pypiForm.package_name = '';

                                // Refresh recipes and try to select the newly created one
                                await this.loadRecipes();

                                // Try to find and select the newly created PyPI recipe
                                // PyPI recipes typically have "py-" prefix
                                const pypiPackageName = `py-${packageName}`;
                                const newRecipe = this.recipes.find(r => r.package_name === pypiPackageName);
                                if (newRecipe) {
                                    await this.selectRecipe(newRecipe);
                                }
                            }
                        } else {
                            throw new Error('Failed to create PyPI recipe');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to create PyPI recipe: ${error.message}`);
                        this.pypiResult = {
                            success: false,
                            message: `Failed to create PyPI recipe: ${error.message}`
                        };
                    } finally {
                        this.creatingPypi = false;
                    }
                },

                async copyPackage() {
                    if (!this.copyForm.package_name || !this.sessionId) {
                        this.showNotification('error', 'Please create a session first and enter a package name to copy');
                        return;
                    }

                    this.copyingPackage = true;
                    this.copyResult = null;

                    try {
                        const response = await fetch(`${this.apiBase}/spack/copy-package`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                package_name: this.copyForm.package_name,
                                session_id: this.sessionId
                            })
                        });

                        if (response.ok) {
                            this.copyResult = await response.json();
                            this.showNotification(
                                this.copyResult.success ? 'success' : 'error',
                                this.copyResult.message
                            );

                            if (this.copyResult.success) {
                                // Clear the form
                                this.copyForm.package_name = '';

                                // Refresh recipes and try to select the newly created one
                                await this.loadRecipes();

                                // Try to find and select the newly created package
                                const newRecipe = this.recipes.find(r => r.package_name === this.copyResult.package_name);
                                if (newRecipe) {
                                    await this.selectRecipe(newRecipe);
                                }
                            }
                        } else {
                            throw new Error('Failed to copy package');
                        }
                    } catch (error) {
                        this.showNotification('error', `Failed to copy package: ${error.message}`);
                        this.copyResult = {
                            success: false,
                            message: `Failed to copy package: ${error.message}`
                        };
                    } finally {
                        this.copyingPackage = false;
                    }
                },

                clearInstallOutput() {
                    this.installOutput = [];
                },

                getOutputLineClass(line) {
                    switch (line.type) {
                        case 'start': return 'start-line';
                        case 'error': return 'error-line';
                        case 'complete': return 'complete-line';
                        default: return 'output-line';
                    }
                },

                showNotification(type, message) {
                    this.notification = {
                        show: true,
                        type,
                        message
                    };

                    setTimeout(() => {
                        this.notification.show = false;
                    }, 5000);
                }
            };
        }
    </script>
</body>
</html>
