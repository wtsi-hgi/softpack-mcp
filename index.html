<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spack Package Creation Wizard</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📦</text></svg>">
    <script>
      // Define the wizard app function before Alpine.js loads
      window.wizardApp = function () {
        return {
          currentStep: 1,
          totalSteps: 6,

          // API Configuration
          apiBaseUrl: "{{API_BASE_URL}}",
          sessionId: null,

          // Notification system
          notifications: [],
          notificationId: 0,

          // Package info
          packageName: "",
          pypiName: "", // Store original name for PyPI
          packageType: "",

          // Validation state
          validationCompleted: false,

          // Workflow state
          recipeExists: "",
          recipeChecking: false,
          needsSpecificVersion: "",
          newVersion: "",
          pypiSuccess: "",
          foundInOfficial: "",
          officialChecking: false,
          hasReleases: "",
          releaseUrl: "",
          repoUrl: "",
          buildSuccess: "",
          validationSuccess: "",

          customValidationScript: "",
          validationOutput: [],
          hashSelection: "",
          prUrl: "",

          // API operation states
          apiStates: {
            creatingSession: false,
            runningVersions: false,
            runningChecksum: false,
            creatingPypi: false,
            copyingPackage: false,
            creatingFromUrl: false,
            creatingBlankRecipe: false,
            installingPackage: false,
            validatingPackage: false,
            uninstallingPackage: false,
            gettingCommitInfo: false,
            creatingPR: false,
            loadingRecipes: false,
            creatingRecipe: false,
            savingRecipe: false,
            validatingRecipe: false,
            requestingAccess: false,
          },

          // Recipe editor state
          selectedRecipe: null,
          recipeContent: "",
          validationResult: null,
          aceEditor: null,
          editorCursorInfo: { row: 1, column: 1, lines: 0 },

          // Installation output state
          installOutput: [],

          // Validation output state
          validationOutput: [],

          // UI state
          showDetailedLog: false,

          // API results
          apiResults: {
            sessionInfo: null,
            versions: null,
            checksums: null,
            pypiResult: null,
            copyResult: null,
            urlResult: null,
            blankRecipeResult: null,
            installResult: null,
            validationResult: null,
            uninstallResult: null,
            commitInfo: null,
            prResult: null,
            recipes: null,
            recipeCreateResult: null,
            accessRequestResult: null,
          },

          // Modifications
          modifications: {
            dependencies: false,
            optional: false,
            patches: false,
            buildFlags: false,
            classType: false,
          },

          // Collaborator access
          hasCollaboratorAccess: "",
          githubUsername: "",

          // Watch for changes to packageName and auto-convert
          init() {
            this.$watch('packageName', (value, oldValue) => {
              // Always store the original name as pypiName
              this.pypiName = value;
            });
          },

          getRecipeName() {
            if (!this.packageType || !this.packageName) return "";
            const prefixes = { python: "py-", r: "r-", other: "" };
            // Convert dots and underscores to dashes for Spack recipe name
            const convertedName = this.packageName.replace(/[._]/g, '-');
            return prefixes[this.packageType] + convertedName;
          },

          getValidationScript() {
            if (!this.packageType || !this.packageName) return "";
            const scripts = {
              python: `python -c "import ${this.packageName}"`,
              r: `Rscript -e "library(${this.packageName})"`,
              other: "# Check package documentation for validation",
            };
            return scripts[this.packageType] || "";
          },

          getDefaultValidationScript() {
            if (!this.packageType || !this.packageName) return "";
            const scripts = {
              python: `python -c "import ${this.packageName}"`,
              r: `Rscript -e "library(${this.packageName})"`,
              other: "# Check package documentation for validation",
            };
            return scripts[this.packageType] || "";
          },

          canProceed() {
            switch (this.currentStep) {
              case 1:
                return this.packageName.trim() !== "" && this.packageType !== "";
              case 2:
                return this.recipeExists !== "" && this.recipeExists !== "manual" && !this.recipeChecking;
              case 3:
                if (this.recipeExists === "yes") {
                  return this.needsSpecificVersion !== "";
                } else {
                  if (this.packageType === "python") {
                    return this.pypiSuccess !== "" && (this.pypiSuccess === "yes" || this.foundInOfficial !== "");
                  } else {
                    return this.foundInOfficial !== "" && (this.foundInOfficial === "yes" || this.hasReleases !== "");
                  }
                }
              case 4:
                return true; // Always can proceed from modifications
              case 5:
                return this.buildSuccess === "yes" && this.validationCompleted;
              case 6:
                return this.hasCollaboratorAccess === "yes";
              default:
                return false;
            }
          },

          async nextStep() {
            if (this.canProceed() && this.currentStep < this.totalSteps) {
              // Save recipe when leaving step 4 if there's content to save
              if (this.currentStep === 4 && this.selectedRecipe && this.recipeContent) {
                try {
                  await this.saveRecipeWithValidation();
                } catch (error) {
                  // If save fails, stay on current step
                  console.error("Failed to save recipe:", error);
                  this.showError("Failed to save recipe. Please try again.");
                  return;
                }
              }

              // Clean up ACE editor when leaving step 4
              if (this.currentStep === 4) {
                this.destroyAceEditor();
              }

              this.currentStep++;

              // Auto-check recipe existence when entering step 2
              if (this.currentStep === 2) {
                this.checkRecipeExists();
              }

              // Auto-check official recipe when entering step 3 for new recipes
              if (this.currentStep === 3 && this.recipeExists === "no") {
                this.checkOfficialRecipe();
              }

              // Create/copy recipe to session when entering step 4 from existing recipe
              if (this.currentStep === 4 && this.recipeExists === "yes") {
                try {
                  await this.createRecipeInSession();
                } catch (error) {
                  // If recipe creation fails, stay on current step
                  this.currentStep--;
                  return;
                }
              }

              // Auto-load recipes when entering step 4
              if (this.currentStep === 4) {
                this.loadRecipes();
                // Initialize ACE editor when entering step 4
                this.$nextTick(() => {
                  setTimeout(() => {
                    if (!this.aceEditor && document.getElementById('ace-recipe-editor')) {
                      this.initializeAceEditor();
                      // Ensure editor displays correct content
                      if (this.selectedRecipe) {
                        this.selectRecipe(this.selectedRecipe);
                      }
                    }
                  }, 150);
                });
              }

              // Skip step 3 version check if recipe doesn't exist or skip to step 4 if using existing
              if (this.currentStep === 3 && this.recipeExists === "no") {
                // Stay at step 3 for new recipe creation
              } else if (this.currentStep === 3 && this.recipeExists === "yes" && this.needsSpecificVersion === "no") {
                this.currentStep = 4; // Skip to modifications
              } else if (this.currentStep === 4 && this.recipeExists === "yes" && this.needsSpecificVersion === "no") {
                this.currentStep = 5; // Skip to build
              }
            }
          },

          previousStep() {
            if (this.currentStep > 1) {
              // Clean up ACE editor when leaving step 4
              if (this.currentStep === 4) {
                this.destroyAceEditor();
              }

              this.currentStep--;

              // When returning to step 4, ensure ACE editor and recipe content are synced
              if (this.currentStep === 4) {
                this.$nextTick(() => {
                  setTimeout(() => {
                    if (!this.aceEditor && document.getElementById('ace-recipe-editor')) {
                      this.initializeAceEditor();
                      if (this.selectedRecipe) {
                        this.selectRecipe(this.selectedRecipe);
                      }
                    }
                  }, 150);
                });
              }
            }
          },

          async copyToClipboard(text) {
            if (!text || text.trim() === "") {
              return;
            }

            try {
              // Try modern Clipboard API first
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return;
              }
            } catch (err) {
              // Fallback to document.execCommand
            }

            // Fallback to document.execCommand
            try {
              const textArea = document.createElement('textarea');
              textArea.value = text;
              textArea.style.position = 'fixed';
              textArea.style.left = '-999999px';
              textArea.style.top = '-999999px';
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();

              const successful = document.execCommand('copy');
              document.body.removeChild(textArea);
            } catch (err) {
              console.error("Failed to copy text: ", err);
            }
          },

          // URL Validation Functions
          isValidUrl(url) {
            if (!url || typeof url !== 'string') return false;
            try {
              const urlObj = new URL(url);
              return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch (e) {
              return false;
            }
          },

          isValidReleaseUrl(url) {
            if (!this.isValidUrl(url)) return false;

            // Check if it's a common release archive format
            const releasePatterns = [
              /\.tar\.gz$/i,
              /\.zip$/i,
              /\.tar\.bz2$/i,
              /\.tar\.xz$/i,
              /github\.com\/.*\/.*\/archive/i,
              /gitlab\.com\/.*\/.*\/-/i,
              /bitbucket\.org\/.*\/.*\/downloads/i
            ];

            return releasePatterns.some(pattern => pattern.test(url));
          },

          isValidRepoUrl(url) {
            if (!this.isValidUrl(url)) return false;

            // Check if it's a common repository URL format
            const repoPatterns = [
              /github\.com\/[^\/]+\/[^\/]+$/i,
              /gitlab\.com\/[^\/]+\/[^\/]+$/i,
              /bitbucket\.org\/[^\/]+\/[^\/]+$/i,
              /\.git$/i
            ];

            return repoPatterns.some(pattern => pattern.test(url));
          },

          // API Helper Functions
          async apiRequest(endpoint, method = "GET", data = null) {
            const url = `${this.apiBaseUrl}${endpoint}`;
            const options = {
              method,
              headers: {
                "Content-Type": "application/json",
              },
            };

            if (data) {
              options.body = JSON.stringify(data);
            }

            try {
              const response = await fetch(url, options);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              return await response.json();
            } catch (error) {
              console.error("API request failed:", error);
              throw error;
            }
          },

          async createSession() {
            if (this.sessionId) return;

            this.apiStates.creatingSession = true;
            try {
              // First, pull the latest updates from spack-repo
              const pullResult = await this.apiRequest("/git/pull", "POST", {});

              if (pullResult.success) {
                // Spack-repo updated successfully
              } else {
                console.warn("Failed to update spack-repo, continuing anyway:", pullResult.message);
                // Don't fail the session creation if git pull fails
              }

              // Then create the session
              const result = await this.apiRequest("/sessions/create", "POST");
              this.sessionId = result.session_id;
              this.apiResults.sessionInfo = result;
              this.apiResults.pullResult = pullResult;
            } catch (error) {
              console.error("Failed to create session:", error);
              this.showError("Failed to create session. Please try again.");
            } finally {
              this.apiStates.creatingSession = false;
            }
          },

          async ensureSession() {
            if (!this.sessionId) {
              await this.createSession();
            }
          },

          // Spack API Functions
          async runSpackVersions() {
            await this.ensureSession();
            this.apiStates.runningVersions = true;
            try {
              const result = await this.apiRequest("/spack/versions", "POST", {
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.versions = result;
              return result;
            } catch (error) {
              console.error("Failed to get versions:", error);
              this.showError("Failed to get package versions. Please try again.");
            } finally {
              this.apiStates.runningVersions = false;
            }
          },

          getVersionsWithChecksumsDisplay() {
            if (!this.apiResults.versions?.version_info) return "";

            const versionInfo = this.apiResults.versions.version_info;
            const checksummed = versionInfo.filter((v) => v.has_checksum).length;
            const total = versionInfo.length;

            return `${total} versions found (${checksummed} with checksums available)`;
          },

          getVersionsForDisplay() {
            if (!this.apiResults.versions?.version_info) {
              return this.apiResults.versions?.versions || [];
            }
            return this.apiResults.versions.version_info.map((v) => v.version);
          },

          async runSpackChecksum() {
            await this.ensureSession();
            this.apiStates.runningChecksum = true;
            try {
              const result = await this.apiRequest("/spack/checksum", "POST", {
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.checksums = result;
              return result;
            } catch (error) {
              console.error("Failed to get checksums:", error);
              this.showError("Failed to get package checksums. Please try again.");
            } finally {
              this.apiStates.runningChecksum = false;
            }
          },

          async runPyPackageCreator() {
            await this.ensureSession();
            this.apiStates.creatingPypi = true;
            try {
              const result = await this.apiRequest("/spack/create-pypi", "POST", {
                package_name: this.pypiName || this.packageName, // Use original if available
                session_id: this.sessionId,
              });
              this.apiResults.pypiResult = result;
              this.pypiSuccess = result.success ? "yes" : "no";
              return result;
            } catch (error) {
              console.error("Failed to create PyPI package:", error);
              this.pypiSuccess = "no";
              this.showError("Failed to create PyPI package. Please try again.");
            } finally {
              this.apiStates.creatingPypi = false;
            }
          },

          async runCopyPackage() {
            await this.ensureSession();
            this.apiStates.copyingPackage = true;
            try {
              const result = await this.apiRequest("/spack/copy-package", "POST", {
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.copyResult = result;
              return result;
            } catch (error) {
              console.error("Failed to copy package:", error);
              this.showError("Failed to copy package. Please try again.");
            } finally {
              this.apiStates.copyingPackage = false;
            }
          },

          async runCreateFromUrl() {
            await this.ensureSession();
            this.apiStates.creatingFromUrl = true;
            try {
              const result = await this.apiRequest("/spack/create-from-url", "POST", {
                url: this.releaseUrl,
                session_id: this.sessionId,
              });
              this.apiResults.urlResult = result;
              return result;
            } catch (error) {
              console.error("Failed to create from URL:", error);
              this.showError("Failed to create recipe from URL. Please try again.");
            } finally {
              this.apiStates.creatingFromUrl = false;
            }
          },

          async runCreateBlankRecipe() {
            await this.ensureSession();
            this.apiStates.creatingBlankRecipe = true;
            try {
              const result = await this.apiRequest(`/recipes/${this.sessionId}/${this.getRecipeName()}/create`, "POST");
              this.apiResults.blankRecipeResult = result;
              return result;
            } catch (error) {
              console.error("Failed to create blank recipe:", error);
              this.showError("Failed to create blank recipe. Please try again.");
            } finally {
              this.apiStates.creatingBlankRecipe = false;
            }
          },

          async runSpackInstall() {
            await this.ensureSession();
            this.apiStates.installingPackage = true;
            this.clearInstallOutput();
            this.resetValidationState();

            try {
              const requestBody = {
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              };

              const response = await fetch(`${this.apiBaseUrl}/spack/install/stream`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody),
              });

              if (response.ok) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let installSuccess = false;

                while (true) {
                  const { done, value } = await reader.read();
                  if (done) break;

                  const chunk = decoder.decode(value);
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      try {
                        const jsonData = line.slice(6);
                        const data = JSON.parse(jsonData);
                        this.installOutput.push(data);

                        // Auto-scroll to bottom
                        this.$nextTick(() => {
                          const outputContainer = document.querySelector(".stream-output");
                          if (outputContainer) {
                            outputContainer.scrollTop = outputContainer.scrollHeight;
                          }
                        });

                        // Check if installation completed successfully
                        if (data.type === "complete") {
                          installSuccess = data.success === true;
                          // Store the complete result including detailed_failed_log
                          this.apiResults.installResult = {
                            success: data.success,
                            package_name: this.getRecipeName(),
                            message: data.data || (data.success ? "Installation completed successfully" : "Installation failed"),
                            install_digest: data.install_digest,
                            detailed_failed_log: data.detailed_failed_log,
                          };
                        }
                      } catch (e) {
                        console.error("Failed to parse SSE data:", e);
                        console.error("Problematic line:", line);
                        console.error("JSON data that failed:", line.slice(6));
                      }
                    }
                  }
                }

                this.buildSuccess = installSuccess ? "yes" : "no";
                // The installResult is now set in the complete event above
              } else {
                throw new Error("Failed to start installation");
              }
            } catch (error) {
              console.error("Failed to install package:", error);
              this.buildSuccess = "no";
              this.installOutput.push({
                type: "error",
                data: `Installation failed: ${error.message}`,
                timestamp: Date.now() / 1000,
              });
            } finally {
              this.apiStates.installingPackage = false;
            }
          },

          async runPackageValidationStream() {
            await this.ensureSession();
            this.apiStates.validatingPackage = true;
            this.validationOutput = [];

            // Initialize validation result to prevent null errors
            this.apiResults.validationResult = {
              success: false,
              message: "Validation in progress...",
              package_name: this.packageName,
              package_type: this.packageType,
              validation_command: "Command will be available after validation",
              validation_output: "",
            };

            // Get the installation digest from the installation result
            // The backend will handle truncating to 7 characters for spack load
            const installationDigest = this.apiResults.installResult && this.apiResults.installResult.install_digest ? this.apiResults.installResult.install_digest : null;

            try {
              const requestBody = {
                package_name: this.packageName,
                package_type: this.packageType,
                installation_digest: installationDigest,
                custom_validation_script: this.customValidationScript || this.getDefaultValidationScript(),
                session_id: this.sessionId,
              };

              const response = await fetch(`${this.apiBaseUrl}/spack/validate/stream`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody),
              });

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      this.validationOutput.push(data);

                      // Update validation success on completion
                      if (data.type === "complete") {
                        this.validationSuccess = data.success ? "yes" : "no";
                        this.validationCompleted = true;
                        this.apiResults.validationResult = {
                          success: data.success || false,
                          message: data.data || "Validation completed",
                          package_name: data.package_name || this.packageName,
                          package_type: data.package_type || "python",
                          validation_command: data.validation_command || "Command not available",
                          validation_output: this.validationOutput.map((o) => o.data).join("\n"),
                        };
                      }
                    } catch (e) {
                      console.error("Failed to parse validation stream data:", e);
                    }
                  }
                }
              }
            } catch (error) {
              console.error("Failed to validate package with streaming:", error);
              this.validationSuccess = "no";
              this.validationCompleted = true;
              this.validationOutput.push({
                type: "error",
                data: `Validation failed: ${error.message}`,
                timestamp: Date.now() / 1000,
              });

              // Ensure validation result is set even on error
              if (!this.apiResults.validationResult) {
                this.apiResults.validationResult = {
                  success: false,
                  message: `Validation failed: ${error.message}`,
                  package_name: this.packageName,
                  package_type: this.packageType,
                  validation_command: "Command not available due to error",
                  validation_output: this.validationOutput.map((o) => o.data).join("\n"),
                };
              }
            } finally {
              this.apiStates.validatingPackage = false;
            }
          },

          async runSpackUninstallAll() {
            await this.ensureSession();
            this.apiStates.uninstallingPackage = true;
            try {
              const result = await this.apiRequest("/spack/uninstall-all", "POST", {
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.uninstallResult = result;
              return result;
            } catch (error) {
              console.error("Failed to uninstall package:", error);
              this.showError("Failed to uninstall package. Please try again.");
            } finally {
              this.apiStates.uninstallingPackage = false;
            }
          },

          // Git API Functions
          async runGetCommitInfo() {
            await this.ensureSession();
            this.apiStates.gettingCommitInfo = true;
            try {
              const result = await this.apiRequest("/git/commit-info", "POST", {
                repo_url: this.repoUrl,
                session_id: this.sessionId,
                package_name: this.getRecipeName(),
              });
              this.apiResults.commitInfo = result;
              return result;
            } catch (error) {
              console.error("Failed to get commit info:", error);
              this.showError("Failed to get git commit info. Please try again.");
            } finally {
              this.apiStates.gettingCommitInfo = false;
            }
          },

          async runCreatePullRequest() {
            await this.ensureSession();
            this.apiStates.creatingPR = true;
            try {
              const result = await this.apiRequest("/git/pull-request", "POST", {
                package_name: this.packageName,
                recipe_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.prResult = result;
              return result;
            } catch (error) {
              console.error("Failed to create pull request:", error);
              this.showError("Failed to create pull request. Please try again.");
            } finally {
              this.apiStates.creatingPR = false;
            }
          },

          async requestCollaboratorAccess() {
            if (!this.githubUsername.trim()) {
              this.showError("Please enter your GitHub username.");
              return;
            }

            this.apiStates.requestingAccess = true;
            try {
              const result = await this.apiRequest("/access/request", "POST", {
                github_username: this.githubUsername.trim(),
                package_name: this.getRecipeName(),
                session_id: this.sessionId,
              });
              this.apiResults.accessRequestResult = result;

              if (result.success) {
                this.showSuccess("Access request sent successfully!");
              } else {
                this.showError("Failed to send access request: " + result.message);
              }

              return result;
            } catch (error) {
              console.error("Failed to request collaborator access:", error);
              this.showError("Failed to request collaborator access. Please try again.");
              this.apiResults.accessRequestResult = {
                success: false,
                message: error.message,
              };
            } finally {
              this.apiStates.requestingAccess = false;
            }
          },

          async loadRecipes() {
            await this.ensureSession();
            this.apiStates.loadingRecipes = true;
            try {
              const result = await this.apiRequest(`/recipes/${this.sessionId}`);
              this.apiResults.recipes = result.recipes;

              // Auto-select the current package's recipe if not already selected
              if (!this.selectedRecipe && this.packageName) {
                // First try exact match with getRecipeName()
                let currentRecipe = result.recipes.find((r) => r.package_name === this.getRecipeName());

                // If no exact match found and we have recipes, try to find the most recently created one
                // This handles cases where URL creation creates a different recipe name
                if (!currentRecipe && result.recipes.length > 0) {
                  // Sort recipes by creation time (assuming newer recipes come later in the list)
                  // or just take the first available recipe as fallback
                  currentRecipe = result.recipes[0];
                }

                if (currentRecipe) {
                  await this.selectRecipe(currentRecipe);
                }
              }

              return result;
            } catch (error) {
              console.error("Failed to load recipes:", error);
              this.showError("Failed to load recipes. Please try again.");
            } finally {
              this.apiStates.loadingRecipes = false;
            }
          },

          async createRecipeInSession() {
            await this.ensureSession();
            this.apiStates.creatingRecipe = true;
            try {
              const result = await this.apiRequest(`/recipes/${this.sessionId}/${this.getRecipeName()}/create`, "POST");
              this.apiResults.recipeCreateResult = result;
              return result;
            } catch (error) {
              console.error("Failed to create recipe in session:", error);
              this.showError("Failed to create recipe in session. Please try again.");
              throw error;
            } finally {
              this.apiStates.creatingRecipe = false;
            }
          },

          async selectRecipe(recipe) {
            this.selectedRecipe = recipe;
            this.validationResult = null;

            if (recipe && recipe.exists) {
              try {
                const response = await this.apiRequest(`/recipes/${this.sessionId}/${recipe.package_name}`);
                this.recipeContent = response.content;
                // Update ACE editor content if it's initialized
                if (this.aceEditor) {
                  this.updateAceEditorContent(this.recipeContent);
                }
              } catch (error) {
                console.error("Failed to load recipe content:", error);
                this.showError("Failed to load recipe content. Please try again.");
              }
            } else {
              this.recipeContent = "";
              // Clear ACE editor content if it's initialized
              if (this.aceEditor) {
                this.updateAceEditorContent("");
              }
            }
          },

          async validateRecipe() {
            if (!this.selectedRecipe || !this.recipeContent) return;

            this.apiStates.validatingRecipe = true;
            try {
              const response = await this.apiRequest(`/recipes/${this.sessionId}/${this.selectedRecipe.package_name}/validate`, "POST", {
                content: this.recipeContent,
                package_name: this.selectedRecipe.package_name,
              });

              this.validationResult = response;
            } catch (error) {
              console.error("Failed to validate recipe:", error);
              this.showError("Failed to validate recipe. Please try again.");
            } finally {
              this.apiStates.validatingRecipe = false;
            }
          },

          async saveRecipe() {
            if (!this.selectedRecipe || !this.recipeContent) return;

            this.apiStates.savingRecipe = true;
            try {
              await this.apiRequest(`/recipes/${this.sessionId}/${this.selectedRecipe.package_name}`, "PUT", {
                content: this.recipeContent,
                description: `Updated by wizard at ${new Date().toISOString()}`,
              });

              // Update the recipe in the list to reflect the save
              await this.loadRecipes();

              // Re-select the current recipe to maintain selection
              if (this.selectedRecipe) {
                const updatedRecipe = this.apiResults.recipes.find((r) => r.package_name === this.selectedRecipe.package_name);
                if (updatedRecipe) {
                  this.selectedRecipe = updatedRecipe;
                }
              }
            } catch (error) {
              console.error("Failed to save recipe:", error);
              // Error handling is done through the UI state (button disabled, etc.)
            } finally {
              this.apiStates.savingRecipe = false;
            }
          },

          async checkRecipeExists() {
            if (!this.packageName.trim()) return;

            this.recipeChecking = true;
            const recipeName = this.getRecipeName();

            // Use GitHub's public API with proper headers
            const url = `https://api.github.com/repos/wtsi-hgi/spack-repo/contents/packages/${recipeName}/package.py`;

            try {
              const response = await fetch(url, {
                method: "GET",
                headers: {
                  Accept: "application/vnd.github.v3+json",
                  "User-Agent": "Spack-Package-Wizard",
                },
              });

              if (response.status === 200) {
                this.recipeExists = "yes";
              } else if (response.status === 404) {
                this.recipeExists = "no";
              } else {
                // For other status codes, default to no
                this.recipeExists = "no";
              }
            } catch (error) {
              console.error("Error checking recipe existence:", error);
              // Fallback: show manual check option
              this.recipeExists = "manual";
            } finally {
              this.recipeChecking = false;
            }
          },

          async checkOfficialRecipe() {
            if (!this.packageName.trim()) return;

            this.officialChecking = true;

            // Use GitHub's public API to check official Spack repository
            // For py-, r-, and perl- packages, use underscores in the builtin repo
            let officialPackageName;
            if (this.packageType === "python") {
              officialPackageName = "py_" + this.packageName;
            } else if (this.packageType === "r") {
              officialPackageName = "r_" + this.packageName;
            } else if (this.packageName.startsWith("perl-")) {
              officialPackageName = this.packageName.replace("perl-", "perl_");
            } else {
              officialPackageName = this.packageName;
            }

            const url = `https://api.github.com/repos/spack/spack-packages/contents/repos/spack_repo/builtin/packages/${officialPackageName}/package.py?ref=78f95ff38d591cbe956a726f4a93f57d21840f86`;

            try {
              const response = await fetch(url, {
                method: "GET",
                headers: {
                  Accept: "application/vnd.github.v3+json",
                  "User-Agent": "Spack-Package-Wizard",
                },
              });

              if (response.status === 200) {
                this.foundInOfficial = "yes";
              } else if (response.status === 404) {
                this.foundInOfficial = "no";
              } else {
                // For other status codes, default to no
                this.foundInOfficial = "no";
              }
            } catch (error) {
              console.error("Error checking official recipe existence:", error);
              // Fallback: default to no
              this.foundInOfficial = "no";
            } finally {
              this.officialChecking = false;
            }
          },

          getValidationCommand() {
            // Show the command that will be executed by the backend
            // The backend will use the first 7 characters of the installation digest
            const installationDigest = this.apiResults.installResult && this.apiResults.installResult.install_digest ? this.apiResults.installResult.install_digest : null;
            const shortDigest = installationDigest ? installationDigest.substring(0, 7) : null;
            const loadSpec = shortDigest ? `/${shortDigest}` : this.getRecipeName();
            const validationScript = this.customValidationScript || this.getDefaultValidationScript();
            return `singularity exec --bind /mnt/data /home/ubuntu/spack.sif bash -c 'source <(/opt/spack/bin/spack load --sh ${loadSpec}); ${validationScript}'`;
          },

          getPrCommands() {
            return `git add .
git commit -m "Add ${this.getRecipeName()} recipe"
git push origin add-${this.packageName}-recipe`;
          },

          getCommitCommands() {
            return `spack create --skip-editor ${this.getRecipeName()}
git clone ${this.repoUrl}
COMMIT=$(git log -1 --format='%H')
DATE=$(git log -1 --format='%cd' --date=format:'%Y%m%d')`;
          },

          clearInstallOutput() {
            this.installOutput = [];
          },

          clearValidationOutput() {
            this.validationOutput = [];
          },

          resetValidationState() {
            this.validationCompleted = false;
            this.validationSuccess = "";
            this.validationOutput = [];
            if (this.apiResults) {
              this.apiResults.validationResult = null;
            }
          },

          getOutputLineClass(line) {
            switch (line.type) {
              case "start":
                return "start-line";
              case "error":
                return "error-line";
              case "complete":
                return "complete-line";
              default:
                return "output-line";
            }
          },

          getPyPackageCreatorCommand() {
            return `cd ~/r-spack-recipe-builder\n./PyPackageCreator.py -f ${this.pypiName || this.packageName}`;
          },

          getVersionCommand() {
            if (this.newVersion && this.apiResults.checksums && this.apiResults.checksums.checksums && this.apiResults.checksums.checksums[this.newVersion]) {
              return `version("${this.newVersion}", sha256="${this.apiResults.checksums.checksums[this.newVersion]}")`;
            }
            return "";
          },

          // Notification methods
          addNotification(message, type = "error") {
            const id = ++this.notificationId;
            this.notifications.push({
              id,
              message,
              type,
              timestamp: Date.now(),
            });

            // Auto-remove after 5 seconds
            setTimeout(() => {
              this.removeNotification(id);
            }, 5000);
          },

          removeNotification(id) {
            this.notifications = this.notifications.filter((n) => n.id !== id);
          },

          showError(message) {
            this.addNotification(message, "error");
          },

          showSuccess(message) {
            this.addNotification(message, "success");
          },

          showInfo(message) {
            this.addNotification(message, "info");
          },

          // ACE Editor Methods
          initializeAceEditor() {
            if (this.aceEditor) {
              this.aceEditor.destroy();
            }

            this.aceEditor = ace.edit("ace-recipe-editor");
            this.aceEditor.setTheme("ace/theme/github");
            this.aceEditor.session.setMode("ace/mode/python");

            // Configure editor settings
            this.aceEditor.setOptions({
              fontSize: 14,
              showPrintMargin: false,
              highlightActiveLine: true,
              highlightSelectedWord: true,
              cursorStyle: "ace",
              mergeUndoDeltas: true,
              behavioursEnabled: true,
              wrapBehavioursEnabled: true,
              autoScrollEditorIntoView: true,
              copyWithEmptySelection: false,
              useSoftTabs: true,
              tabSize: 4,
              wrap: false,
              foldStyle: "markbegin"
            });

            // Show whitespace and tabs
            this.aceEditor.setOption("showInvisibles", true);

            // Add keyboard shortcuts for save
            this.aceEditor.commands.addCommand({
              name: 'saveRecipe',
              bindKey: {win: 'Ctrl-S', mac: 'Cmd-S'},
              exec: () => {
                this.saveRecipeWithValidation();
              },
              readOnly: false
            });

            // Sync content changes back to Alpine data
            this.aceEditor.session.on('change', () => {
              this.recipeContent = this.aceEditor.getValue();
              this.updateEditorInfo();
            });

            // Track cursor position changes
            this.aceEditor.selection.on('changeCursor', () => {
              this.updateEditorInfo();
            });

            // Set initial content if available
            if (this.recipeContent) {
              this.aceEditor.setValue(this.recipeContent, -1); // -1 moves cursor to start
            }

            // Update initial editor info
            this.updateEditorInfo();
          },

          updateAceEditorContent(content) {
            if (this.aceEditor && content !== this.aceEditor.getValue()) {
              const cursorPosition = this.aceEditor.getCursorPosition();
              this.aceEditor.setValue(content, -1);
              this.aceEditor.moveCursorToPosition(cursorPosition);
              this.updateEditorInfo();
            }
          },

          updateEditorInfo() {
            if (this.aceEditor) {
              const cursor = this.aceEditor.getCursorPosition();
              this.editorCursorInfo = {
                row: cursor.row + 1, // 1-based line numbering
                column: cursor.column + 1, // 1-based column numbering
                lines: this.aceEditor.session.getLength()
              };
            }
          },

          async saveRecipeWithValidation() {
            if (!this.selectedRecipe || !this.recipeContent) {
              this.showError("No recipe selected or content is empty.");
              return;
            }

            try {
              // Save first
              await this.saveRecipe();
              this.showSuccess("Recipe saved successfully!");

              // Then validate automatically
              try {
                await this.validateRecipe();
                if (this.validationResult && this.validationResult.is_valid) {
                  this.showSuccess("Recipe validation passed!");
                }
              } catch (validationError) {
                this.showError("Recipe saved but validation failed: " + validationError.message);
              }

            } catch (error) {
              this.showError("Failed to save recipe: " + error.message);
            }
          },

          destroyAceEditor() {
            if (this.aceEditor) {
              this.aceEditor.destroy();
              this.aceEditor = null;
            }
          },
        };
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- ACE Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-github.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-whitespace.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 40px 20px;
        background-color: #fafafa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: white;
        color: #333;
        padding: 40px 0;
        margin-bottom: 40px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
      }

      .header h1 {
        font-weight: 300;
        font-size: 2.5rem;
        margin: 0 0 10px 0;
        letter-spacing: -0.5px;
      }

      .header p {
        font-weight: 400;
        color: #666;
        margin: 0;
        font-size: 1.1rem;
      }

      .wizard-container {
        background: white;
        padding: 60px;
        max-width: 1000px;
        margin: 0 auto;
        border: 1px solid #e0e0e0;
      }

      .progress-bar {
        background: #f0f0f0;
        height: 2px;
        margin-bottom: 60px;
        overflow: hidden;
      }

      .progress-fill {
        background: #333;
        height: 100%;
        transition: width 0.3s ease;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      input[type="text"],
      input[type="url"],
      select,
      textarea {
        width: 100%;
        padding: 12px 0;
        border: none;
        border-bottom: 1px solid #e0e0e0;
        font-size: 16px;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
        background: transparent;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-bottom-color: #333;
      }

      .invalid-input {
        border-bottom-color: #dc3545 !important;
      }

      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
      }

      .btn {
        background: #333;
        color: white;
        border: 1px solid #333;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-right: 10px;
      }

      .btn:hover {
        background: white;
        color: #333;
      }

      .btn-secondary {
        background: white;
        color: #333;
        border-color: #ccc;
      }

      .btn-secondary:hover {
        background: #f5f5f5;
      }

      .btn-success {
        background: #28a745;
        border-color: #28a745;
      }

      .btn-success:hover {
        background: white;
        color: #28a745;
      }

      .btn-warning {
        background: #ffc107;
        color: #333;
        border-color: #ffc107;
      }

      .btn-warning:hover {
        background: white;
      }

      .command-box {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        padding: 20px;
        font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
        font-size: 14px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .command-box span {
        flex: 1;
        line-height: 1.5;
      }

      .play-btn {
        background: #28a745;
        color: white;
        border: 1px solid #28a745;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 80px;
        justify-content: center;
      }

      .play-btn:hover {
        background: white;
        color: #28a745;
      }

      .play-btn:disabled {
        background: #6c757d;
        border-color: #6c757d;
        color: white;
        cursor: not-allowed;
      }

      .play-btn:disabled:hover {
        background: #6c757d;
        color: white;
      }

      .copy-btn {
        background: #333;
        color: white;
        border: 1px solid #333;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        border-radius: 4px;
      }

      .copy-btn:hover {
        background: white;
        color: #333;
      }

      .info-box {
        background: #f8f9fa;
        border-left: 4px solid #333;
        padding: 20px;
        margin: 20px 0;
      }

      .warning-box {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 20px;
        margin: 20px 0;
      }

      .success-box {
        background: #f1f8e9;
        border-left: 4px solid #28a745;
        padding: 20px;
        margin: 20px 0;
      }

      .radio-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 10px 0;
      }

      .step-title {
        color: #333;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 15px;
        margin-bottom: 30px;
        font-weight: 500;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
        padding-top: 30px;
        border-top: 1px solid #e0e0e0;
      }

      .stream-output {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
        max-height: 300px;
        overflow-y: auto;
        overflow-x: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      .stream-output h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
      }

      .start-line {
        color: #007bff;
        font-weight: bold;
      }

      .error-line {
        color: #dc3545;
      }

      .complete-line {
        color: #28a745;
        font-weight: bold;
      }

      .output-line {
        color: #333;
      }

      /* Notification System */
      .notifications-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
      }

      .notification {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 15px 20px;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
        position: relative;
        font-size: 14px;
        line-height: 1.4;
      }

      .notification.error {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
      }

      .notification.success {
        border-left: 4px solid #28a745;
        background: #f8fff9;
      }

      .notification.info {
        border-left: 4px solid #007bff;
        background: #f8f9ff;
      }

      .notification .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification .close-btn:hover {
        color: #333;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* ACE Editor Styles */
      .ace-editor-container {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        position: relative;
        background: #fafafa;
      }

      .ace-editor {
        width: 100%;
        height: 500px;
        font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
        font-size: 14px;
        line-height: 1.6;
      }

      .ace-editor-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        font-size: 12px;
        color: #666;
      }

      .ace-editor-info {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .ace-editor-shortcuts {
        font-size: 11px;
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Spack Package Creation Guide</h1>
      <p>Step-by-step workflow for creating Spack packages</p>
    </div>

    <div class="wizard-container" x-data="wizardApp()" x-init="init()">
      <!-- Notification System -->
      <div class="notifications-container">
        <template x-for="notification in notifications" :key="notification.id">
          <div class="notification" :class="notification.type">
            <button class="close-btn" @click="removeNotification(notification.id)">&times;</button>
            <div x-text="notification.message"></div>
          </div>
        </template>
      </div>
      <!-- Session Management -->
      <div x-show="!sessionId" style="text-align: center; padding: 80px 40px">
        <h2 style="font-size: 2.5rem; font-weight: 300; margin-bottom: 20px; color: #333">Welcome! 👋</h2>
        <p style="font-size: 1.2rem; color: #666; margin-bottom: 40px; line-height: 1.6">Create and manage Spack packages with ease.</p>
        <button class="btn btn-success" @click="createSession()" :disabled="apiStates.creatingSession" style="font-size: 16px; padding: 15px 30px">
          <span x-show="!apiStates.creatingSession">Start</span>
          <span x-show="apiStates.creatingSession">Starting...</span>
        </button>
      </div>

      <!-- Progress Bar -->
      <div x-show="sessionId" class="progress-bar">
        <div class="progress-fill" :style="`width: ${(currentStep / totalSteps) * 100}%`"></div>
      </div>

      <!-- Step 1: Package Information -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 1 }">
        <h2 class="step-title">Step 1: Package Information</h2>

        <div class="input-group">
          <label for="packageName">Package Name:</label>
          <input type="text" id="packageName" x-model="packageName" placeholder="e.g., numpy, ggplot2, cmake, fastapi" />
          <div x-show="packageName && (packageName.includes('.') || packageName.includes('_'))" class="warning-box" style="margin-top: 10px; padding: 10px; font-size: 13px;">
            <strong>Note:</strong> Spack recipe names cannot contain dots or underscores.<br/>
            <strong>Original name:</strong> <code x-text="packageName"></code> (used for PyPI)<br/>
            <strong>Spack recipe name:</strong> <code x-text="packageName.replace(/[._]/g, '-')"></code>
          </div>
        </div>

        <div class="input-group">
          <label for="packageType">Package Type:</label>
          <select id="packageType" x-model="packageType">
            <option value="">Select package type...</option>
            <option value="python">Python Package</option>
            <option value="r">R Package</option>
            <option value="other">Other Package</option>
          </select>
        </div>


        <div class="info-box" x-show="packageName">
          Spack Recipe Name: <strong x-text="getRecipeName()"></strong>
        </div>
      </div>

      <!-- Step 2: Recipe Existence Check -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 2 }">
        <h2 class="step-title">Step 2: Check if Recipe Exists</h2>

        <div class="info-box">Checking if a recipe already exists in the spack-repo...</div>

        <div x-show="recipeChecking" class="info-box">
          <div style="display: flex; align-items: center; gap: 10px">
            <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
            Checking GitHub repository for
            <strong x-text="getRecipeName()"></strong>...
          </div>
        </div>

        <div x-show="!recipeChecking && recipeExists === 'yes'" class="success-box">
          ✅ Recipe found! The package
          <strong x-text="getRecipeName()"></strong> already exists in the spack-repo.
        </div>

        <div x-show="!recipeChecking && recipeExists === 'no'" class="warning-box">
          ❌ Recipe not found. The package
          <strong x-text="getRecipeName()"></strong> doesn't exist in the spack-repo yet. <br /><br />
          We'll need to create a new recipe for this package.
        </div>

        <div x-show="!recipeChecking && recipeExists === 'manual'" class="info-box">
          ⚠️ Unable to automatically check recipe existence due to network restrictions.
          <br /><br />
          Please manually check if the recipe exists:
          <div class="command-box">
            <span x-text="'ls packages/' + getRecipeName() + '/'"></span>
            <button class="copy-btn" @click="copyToClipboard('ls packages/' + getRecipeName() + '/')">Copy</button>
          </div>

          <div class="input-group">
            <label>Does the recipe exist?</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="exists-yes" x-model="recipeExists" value="yes" />
                <label for="exists-yes">Yes, recipe exists</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="exists-no" x-model="recipeExists" value="no" />
                <label for="exists-no">No, recipe doesn't exist</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3a: Existing Recipe - Version Check -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 3 && recipeExists === 'yes' }">
        <h2 class="step-title">Step 3: Recipe Exists - Version Management</h2>

        <div class="input-group">
          <label>Do you need a specific version?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="version-yes" x-model="needsSpecificVersion" value="yes" />
              <label for="version-yes">Yes, need specific version</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="version-no" x-model="needsSpecificVersion" value="no" />
              <label for="version-no">No, use existing</label>
            </div>
          </div>
        </div>

        <div x-show="needsSpecificVersion === 'yes'">
          <div class="info-box">Add a new version to the existing recipe:</div>

          <div class="input-group">
            <label for="newVersion">New Version:</label>
            <input type="text" id="newVersion" x-model="newVersion" placeholder="e.g., 1.2.3" />
          </div>

          <div class="command-box">
            <span x-text="'spack checksum -b ' + getRecipeName()"></span>
            <button class="play-btn" @click="runSpackChecksum()" :disabled="apiStates.runningChecksum">
              <span x-show="!apiStates.runningChecksum">Run</span>
              <span x-show="apiStates.runningChecksum">Running...</span>
            </button>
          </div>

          <div x-show="apiResults.checksums" class="success-box">
            <strong>Available Checksums:</strong>
            <div x-show="apiResults.checksums && apiResults.checksums.success">
              <!-- Show specific version checksum first if specified -->
              <div x-show="newVersion && apiResults.checksums && apiResults.checksums.checksums && apiResults.checksums.checksums[newVersion]" style="margin-bottom: 15px">
                <strong>Checksum for version <span x-text="newVersion"></span>:</strong>
                <div class="command-box" style="margin: 10px 0; background: #e8f5e8">
                  <span style="font-family: monospace; font-size: 13px; color: #155724" x-text="getVersionCommand()"></span>
                  <button class="copy-btn" @click="copyToClipboard(getVersionCommand())" style="background: #28a745">Copy</button>
                </div>
              </div>

              <div x-data="{ showAllChecksums: false }">
                <button @click="showAllChecksums = !showAllChecksums" class="btn btn-secondary">
                  <span x-text="showAllChecksums ? 'Hide All Checksums' : 'Show All Checksums'"></span>
                </button>
                <div x-show="showAllChecksums" style="margin-top: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto">
                  <template x-for="[version, checksum] in Object.entries(apiResults.checksums && apiResults.checksums.checksums || {})">
                    <div style="margin: 5px 0; padding: 5px; border-radius: 3px" :style="version === newVersion ? 'background-color: #fff3cd; border: 1px solid #ffeaa7;' : ''">
                      <div
                        style="cursor: pointer; background: none; border: none; padding: 0; color: inherit; font: inherit; text-align: left"
                        @click='copyToClipboard("version(\"" + version + "\", sha256=\"" + checksum + "\")")'
                        title="Click to copy"
                      >
                        version(<span x-text="version"></span>, sha256=<span x-text="checksum"></span>)
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <div x-show="apiResults.checksums && !apiResults.checksums.success" class="warning-box">
              Error:
              <span x-text="apiResults.checksums && apiResults.checksums.message"></span>
            </div>
          </div>

          <div x-show="apiResults.checksums && apiResults.checksums.success" class="warning-box">
            <strong>Manual Step:</strong> Edit the recipe file in the next step to add the new version and SHA256 checksum from the output above.
          </div>
        </div>

        <div x-show="needsSpecificVersion === 'no'">
          <div class="success-box">✅ Great! You can use the existing recipe as-is. Proceed to installation testing.</div>
        </div>
      </div>

      <!-- Step 3b: New Recipe Creation -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 3 && recipeExists === 'no' }">
        <h2 class="step-title">Step 3: Create New Recipe</h2>

        <div x-show="packageType === 'python'">
          <div class="info-box">For Python packages, we'll try the automated PyPackageCreator first:</div>

          <div class="command-box">
            <span style="white-space: pre-line" x-text="getPyPackageCreatorCommand()"></span>
            <button class="play-btn" @click="runPyPackageCreator()" :disabled="apiStates.creatingPypi">
              <span x-show="!apiStates.creatingPypi">Run</span>
              <span x-show="apiStates.creatingPypi">Creating...</span>
            </button>
          </div>

          <div x-show="apiResults.pypiResult && apiResults.pypiResult.success" class="success-box">
            <strong>✅ PyPI Package Created Successfully!</strong><br />
          </div>
          <div x-show="apiResults.pypiResult && !apiResults.pypiResult.success" class="warning-box">
            <strong>❌ PyPI Package Creation Failed</strong><br />
            Error:
            <span x-text="apiResults.pypiResult && apiResults.pypiResult.message"></span>
          </div>

          <div class="input-group">
            <label>Was PyPI creation successful?</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="pypi-yes" x-model="pypiSuccess" value="yes" />
                <label for="pypi-yes">Yes, created successfully</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="pypi-no" x-model="pypiSuccess" value="no" />
                <label for="pypi-no">No, failed or incomplete</label>
              </div>
            </div>
          </div>
        </div>

        <div x-show="packageType !== 'python' || pypiSuccess === 'no'">
          <div class="info-box">Let's check the official Spack repository and create a recipe:</div>

          <div x-show="officialChecking" class="info-box">
            <div style="display: flex; align-items: center; gap: 10px">
              <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
              Checking official Spack repository for
              <strong x-text="packageName"></strong>...
            </div>
          </div>

          <div x-show="!officialChecking && foundInOfficial === 'yes'" class="success-box">✅ Package found in official Spack repository! The create command will copy the existing recipe.</div>

          <div x-show="!officialChecking && foundInOfficial === 'no'" class="warning-box">❌ Package not found in official Spack repository. You'll need to create a recipe manually.</div>

          <div x-show="foundInOfficial === 'yes'" class="command-box">
            <span x-text="'create ' + getRecipeName()"></span>
            <button class="play-btn" @click="runCopyPackage()" :disabled="apiStates.copyingPackage">
              <span x-show="!apiStates.copyingPackage">Run</span>
              <span x-show="apiStates.copyingPackage">Copying...</span>
            </button>
          </div>

          <div x-show="apiResults.copyResult && !apiResults.copyResult.success" class="warning-box">
            <strong>❌ Package Copy Failed</strong><br />
            Error:
            <span x-text="apiResults.copyResult && apiResults.copyResult.message"></span>
          </div>

          <div x-show="foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success">
            <div class="success-box">
              ✅ Excellent! The official recipe has been copied as a base. You can modify it as needed.
              <br /><br />
            </div>
          </div>

          <div x-show="foundInOfficial === 'no'">
            <div class="input-group">
              <label>Does the project have GitHub releases/tags/commit?</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="releases-yes" x-model="hasReleases" value="yes" />
                  <label for="releases-yes">Yes, has releases/tags</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="releases-no" x-model="hasReleases" value="no" />
                  <label for="releases-no">No releases, use latest commit</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="releases-nothing" x-model="hasReleases" value="nothing" />
                  <label for="releases-nothing">Nothing, create blank template</label>
                </div>
              </div>
            </div>

            <div x-show="hasReleases === 'yes'">
              <div class="input-group">
                <label for="releaseUrl">Release Archive URL:</label>
                <input
                  type="url"
                  id="releaseUrl"
                  x-model="releaseUrl"
                  placeholder="https://github.com/owner/repo/archive/refs/tags/v1.0.0.tar.gz"
                  :class="releaseUrl && !isValidReleaseUrl(releaseUrl) ? 'invalid-input' : ''"
                />
                <div x-show="releaseUrl && !isValidReleaseUrl(releaseUrl)" class="error-message">
                  Please enter a valid release archive URL (e.g., .tar.gz, .zip, or GitHub/GitLab archive URL)
                </div>
              </div>

              <div class="command-box" x-show="releaseUrl && isValidReleaseUrl(releaseUrl)">
                <span x-text="'spack create --skip-editor -b ' + releaseUrl"></span>
                <button class="play-btn" @click="runCreateFromUrl()" :disabled="apiStates.creatingFromUrl">
                  <span x-show="!apiStates.creatingFromUrl">Run</span>
                  <span x-show="apiStates.creatingFromUrl">Creating...</span>
                </button>
              </div>

              <div x-show="apiResults.urlResult && apiResults.urlResult.success" class="success-box"><strong>✅ Recipe Created from URL</strong><br /></div>
              <div x-show="apiResults.urlResult && !apiResults.urlResult.success" class="warning-box">
                <strong>❌ Recipe Creation Failed</strong><br />
                Error:
                <span x-text="apiResults.urlResult && apiResults.urlResult.message"></span>
              </div>
            </div>

            <div x-show="hasReleases === 'no'">
              <div class="input-group">
                <label for="repoUrl">Repository URL:</label>
                <input
                  type="url"
                  id="repoUrl"
                  x-model="repoUrl"
                  placeholder="https://github.com/owner/repo"
                  :class="repoUrl && !isValidRepoUrl(repoUrl) ? 'invalid-input' : ''"
                />
                <div x-show="repoUrl && !isValidRepoUrl(repoUrl)" class="error-message">
                  Please enter a valid repository URL (e.g., GitHub, GitLab, or Bitbucket repository)
                </div>
              </div>

              <div class="command-box" x-show="repoUrl && isValidRepoUrl(repoUrl)">
                <span style="white-space: pre-line" x-text="getCommitCommands()"></span>
                <button class="play-btn" @click="runGetCommitInfo()" :disabled="apiStates.gettingCommitInfo">
                  <span x-show="!apiStates.gettingCommitInfo">Run</span>
                  <span x-show="apiStates.gettingCommitInfo">Getting...</span>
                </button>
              </div>

              <div x-show="apiResults.commitInfo && apiResults.commitInfo.success" class="success-box">
                <strong>✅ Git Commit Info Retrieved!</strong><br />
                Commit:
                <span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_hash"></span><br />
                Date:
                <span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_date"></span><br />
                <br />
                <strong>Added to recipe:</strong><br />
                <code
                  >version("<span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_date"></span>", commit="<span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_hash"></span
                  >")</code
                >
              </div>
              <div x-show="apiResults.commitInfo && !apiResults.commitInfo.success" class="warning-box">
                <strong>❌ Failed to Get Commit Info</strong><br />
                Error:
                <span x-text="apiResults.commitInfo && apiResults.commitInfo.message"></span>
              </div>
            </div>

            <div x-show="hasReleases === 'nothing'">
              <div class="info-box">Creating a blank template recipe using spack create:</div>

              <div class="command-box">
                <span x-text="'spack create --skip-editor ' + getRecipeName()"></span>
                <button class="play-btn" @click="runCreateBlankRecipe()" :disabled="apiStates.creatingBlankRecipe">
                  <span x-show="!apiStates.creatingBlankRecipe">Run</span>
                  <span x-show="apiStates.creatingBlankRecipe">Creating...</span>
                </button>
              </div>

              <div x-show="apiResults.blankRecipeResult && apiResults.blankRecipeResult.success" class="success-box">
                <strong>✅ Blank Template Recipe Created!</strong><br />
              </div>
              <div x-show="apiResults.blankRecipeResult && !apiResults.blankRecipeResult.success" class="warning-box">
                <strong>❌ Blank Recipe Creation Failed</strong><br />
                Error:
                <span x-text="apiResults.blankRecipeResult && apiResults.blankRecipeResult.message"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Recipe Modification -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 4 }">
        <h2 class="step-title">Step 4: Gather Info and Modify Recipe</h2>

        <div x-show="packageType === 'python' && pypiSuccess === 'yes'" class="success-box">✅ <strong>PyPackageCreator was used successfully!</strong></div>

        <div x-show="foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success" class="success-box">✅ <strong>Official recipe was copied successfully!</strong></div>

        <div x-show="hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success" class="success-box">
          ✅ <strong>Blank template recipe was created successfully!</strong>
        </div>

        <div
          x-show="(packageType !== 'python' || pypiSuccess === 'no') && !(foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success) && !(hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success)"
          class="info-box"
        >
          Now you need to research the package and add proper dependencies to the recipe.
        </div>

        <!-- Recipe Editor Section -->
        <div style="margin-bottom: 30px">
          <!-- Recipe Selection Menu -->
          <div style="margin-bottom: 20px">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
              <label style="font-weight: 500; color: #333; font-size: 16px">Select Recipe to Edit:</label>
              <button class="btn btn-secondary" @click="loadRecipes()" :disabled="apiStates.loadingRecipes" style="padding: 8px 16px; font-size: 12px">
                <span x-show="!apiStates.loadingRecipes">Refresh Recipes</span>
                <span x-show="apiStates.loadingRecipes">Loading...</span>
              </button>
            </div>

            <div x-show="apiStates.loadingRecipes" style="text-align: center; padding: 20px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa">
              <div
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  border: 2px solid #333;
                  border-top: 2px solid transparent;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                  margin-right: 10px;
                "
              ></div>
              Loading recipes...
            </div>

            <div
              x-show="!apiStates.loadingRecipes && (!apiResults.recipes || apiResults.recipes.length === 0)"
              style="text-align: center; padding: 20px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa"
            >
              No recipes found in session
            </div>

            <div x-show="!apiStates.loadingRecipes && apiResults.recipes && apiResults.recipes.length > 0">
              <select
                @change="$event.target.value ? selectRecipe(apiResults.recipes.find(r => r.package_name === $event.target.value)) : selectRecipe(null)"
                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; background: white; box-sizing: border-box"
              >
                <option value="">Select a recipe...</option>
                <template x-for="recipe in apiResults.recipes" :key="recipe.package_name">
                  <option :value="recipe.package_name" x-text="recipe.package_name + (recipe.exists ? ' ✓' : ' ✗') + (recipe.package_name === getRecipeName() ? ' (Current Package)' : '')"></option>
                </template>
              </select>

              <!-- Selected Recipe Info -->
              <div x-show="selectedRecipe" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 4px; font-size: 13px">
                <strong x-text="selectedRecipe && selectedRecipe.package_name"></strong>
                <span style="color: #666; margin-left: 10px" x-text="selectedRecipe && selectedRecipe.file_path"></span>
                <span x-show="selectedRecipe && selectedRecipe.size" style="color: #999; margin-left: 10px" x-text="selectedRecipe && '(' + (selectedRecipe.size / 1024).toFixed(1) + ' KB)'"></span>
              </div>
            </div>
          </div>

          <!-- Recipe Editor -->
          <div style="width: 100%">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
              <strong style="font-size: 16px; color: #333">Recipe Editor</strong>
              <div style="display: flex; gap: 10px">
                <button @click="validateRecipe()" :disabled="!selectedRecipe || !recipeContent || apiStates.validatingRecipe" class="btn btn-warning" style="padding: 10px 20px; font-size: 14px">
                  <span x-show="!apiStates.validatingRecipe">Validate Recipe</span>
                  <span x-show="apiStates.validatingRecipe">Validating...</span>
                </button>
                <button @click="saveRecipeWithValidation()" :disabled="!selectedRecipe || !recipeContent || apiStates.savingRecipe || apiStates.validatingRecipe" class="btn btn-success" style="padding: 10px 20px; font-size: 14px">
                  <span x-show="!apiStates.savingRecipe && !apiStates.validatingRecipe">Save & Validate</span>
                  <span x-show="apiStates.savingRecipe">Saving...</span>
                  <span x-show="apiStates.validatingRecipe">Validating...</span>
                </button>
              </div>
            </div>

            <div x-show="!selectedRecipe" style="text-align: center; padding: 60px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa; font-size: 16px">
              Select a recipe from the dropdown above to start editing
            </div>

            <div x-show="selectedRecipe && currentStep === 4" style="width: 100%">
              <div class="ace-editor-container">
                <div class="ace-editor-toolbar">
                  <div class="ace-editor-info">
                    <span>Python Recipe Editor</span>
                    <span x-show="selectedRecipe" x-text="'Editing: ' + (selectedRecipe ? selectedRecipe.package_name : '')"></span>
                    <span x-show="aceEditor" x-text="'Line ' + editorCursorInfo.row + ', Col ' + editorCursorInfo.column + ' • ' + editorCursorInfo.lines + ' lines'"></span>
                  </div>
                  <div class="ace-editor-shortcuts">
                    <span>Ctrl+S / Cmd+S to save & validate</span>
                    <span style="margin-left: 15px; color: #999;">•</span>
                    <span style="margin-left: 5px;">Tabs & spaces visible</span>
                  </div>
                </div>
                <div
                  id="ace-recipe-editor"
                  class="ace-editor"
                  x-init="
                    if (currentStep === 4) {
                      $nextTick(() => {
                        setTimeout(() => {
                          if (!aceEditor && document.getElementById('ace-recipe-editor')) {
                            initializeAceEditor();
                          }
                        }, 100);
                      });
                    }
                  "
                  x-destroy="destroyAceEditor()"
                ></div>
              </div>

              <!-- Validation Results -->
              <div x-show="validationResult" style="margin-top: 20px">
                <div :class="validationResult && validationResult.is_valid ? 'success-box' : 'warning-box'">
                  <div style="font-weight: 500; font-size: 16px">
                    <span x-show="validationResult && validationResult.is_valid">✅ Valid Recipe</span>
                    <span x-show="validationResult && !validationResult.is_valid">❌ Invalid Recipe</span>
                  </div>
                  <div x-show="validationResult && validationResult.errors && validationResult.errors.length > 0" style="margin-top: 15px">
                    <div style="font-weight: 500; color: #dc3545; font-size: 14px">Errors:</div>
                    <ul style="margin: 8px 0; padding-left: 20px">
                      <template x-for="error in (validationResult && validationResult.errors || [])" :key="error">
                        <li style="color: #dc3545; font-size: 14px; margin: 4px 0" x-text="error"></li>
                      </template>
                    </ul>
                  </div>
                  <div x-show="validationResult && validationResult.warnings && validationResult.warnings.length > 0" style="margin-top: 15px">
                    <div style="font-weight: 500; color: #856404; font-size: 14px">Warnings:</div>
                    <ul style="margin: 8px 0; padding-left: 20px">
                      <template x-for="warning in (validationResult && validationResult.warnings || [])" :key="warning">
                        <li style="color: #856404; font-size: 14px; margin: 4px 0" x-text="warning"></li>
                      </template>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          x-show="(packageType !== 'python' || pypiSuccess === 'no') && !(foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success) && !(hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success)"
          class="warning-box"
        >
          <strong>Look at these examples for guidance:</strong><br />
          • Python:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/py-agate/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>py-agate</code></a
          ><br />
          • R:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/r-archr/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>r-archr</code></a
          >, <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/r-plotlistr/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>r-plotlistr</code></a
          ><br />
          • Other:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/samtools/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>samtools</code></a
          ><br /><br />
        </div>


        <div class="input-group">
          <label>Common modifications needed:</label>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="deps"
              x-model="modifications.dependencies"
              :checked="(packageType === 'python' && pypiSuccess === 'yes') || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="deps">Add proper description and homepage URL</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="optional"
              x-model="modifications.optional"
              :checked="(packageType === 'python' && pypiSuccess === 'yes') || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="optional">Add git repository URL and license</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="patches"
              x-model="modifications.patches"
              :checked="(packageType === 'python' && pypiSuccess === 'yes') || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="patches">Add version with commit hash</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="flags"
              x-model="modifications.buildFlags"
              :checked="(packageType === 'python' && pypiSuccess === 'yes') || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="flags">Add dependencies to depends_on()</label>
          </div>
        </div>

        <div x-show="(packageType === 'python' && pypiSuccess === 'yes') || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)" class="warning-box">
          <strong>⚠️ Important:</strong> Even though the recipe was automatically generated/copied with most modifications, always verify the generated recipe for syntax errors and accuracy before
          proceeding to build.
        </div>
      </div>

      <!-- Step 5: Build and Test -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 5 }">
        <h2 class="step-title">Step 5: Build and Test</h2>

        <div class="info-box">Now let's build the package and test it:</div>

        <div class="command-box">
          <span x-text="'spack install ' + getRecipeName()"></span>
          <button class="play-btn" @click="runSpackInstall()" :disabled="apiStates.installingPackage">
            <span x-show="!apiStates.installingPackage">Run</span>
            <span x-show="apiStates.installingPackage">Installing...</span>
          </button>
        </div>

        <!-- Installation Output -->
        <div style="margin: 30px 0">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
            <strong style="font-size: 16px; color: #333">Installation Output</strong>
            <button @click="clearInstallOutput()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px">Clear Output</button>
          </div>
          <div class="stream-output">
            <template x-for="(line, index) in installOutput" :key="index">
              <div :class="getOutputLineClass(line)" x-text="line.data"></div>
            </template>
            <div x-show="installOutput.length === 0" style="color: #888; font-style: italic">Installation output will appear here...</div>
          </div>
        </div>

        <div x-show="apiResults.installResult && !apiResults.installResult.success" class="warning-box">
          <strong>❌ Package Installation Failed</strong><br />
          Error:
          <span x-text="apiResults.installResult && apiResults.installResult.message"></span>
          <br /><br />

          <!-- View Error Log Button -->
          <div x-show="apiResults.installResult && apiResults.installResult.detailed_failed_log" style="margin: 15px 0;">
            <button
              @click="showDetailedLog = !showDetailedLog"
              class="btn btn-warning"
              style="padding: 10px 20px; font-size: 14px;"
            >
              <span x-show="!showDetailedLog">📋 View Detailed Error Log</span>
              <span x-show="showDetailedLog">🔼 Hide Detailed Error Log</span>
            </button>
          </div>

          <!-- Detailed Error Log Display -->
          <div x-show="showDetailedLog && apiResults.installResult && apiResults.installResult.detailed_failed_log" style="margin-top: 15px;">
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd;">
                <strong style="color: #333; font-family: inherit;">Build Log Contents (spack-build-out.txt)</strong>
                <button
                  @click="copyToClipboard(apiResults.installResult.detailed_failed_log)"
                  class="copy-btn"
                  style="font-size: 11px; padding: 4px 8px;"
                >
                  Copy All
                </button>
              </div>
              <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; color: #333;" x-text="apiResults.installResult.detailed_failed_log"></pre>
            </div>
          </div>

          <strong>Troubleshooting:</strong><br />
          • Check the installation output above for error details<br />
          • Use the "View Detailed Error Log" button above for complete build logs<br />
          • Add missing dependencies to the recipe<br />
          • Fix version constraints<br />
          • Add patches if needed<br />
          • Modify build flags<br /><br />
          Fix the recipe and try building again.
        </div>

        <div x-show="buildSuccess === 'yes'">
          <div class="success-box">✅ Build successful! Now let's validate the package:</div>

          <!-- Custom Validation Script Input -->
          <div class="input-group">
            <label for="customValidationScript">Custom Validation Script (optional):</label>
            <textarea
              id="customValidationScript"
              x-model="customValidationScript"
              rows="1"
              :placeholder="getDefaultValidationScript()"
              @focus="customValidationScript === '' ? customValidationScript = getDefaultValidationScript() : null"
            ></textarea>
            <small style="color: #666; font-size: 12px"> Leave empty to use default validation for package type. </small>
          </div>

          <!-- Validation Button -->
          <div class="command-box">
            <span x-text="getValidationCommand()"></span>
            <button class="play-btn" @click="runPackageValidationStream()" :disabled="apiStates.validatingPackage">
              <span x-show="!apiStates.validatingPackage">Run</span>
              <span x-show="apiStates.validatingPackage">Validating...</span>
            </button>
          </div>

          <!-- Validation Status -->
          <div x-show="apiStates.validatingPackage" class="info-box">
            <div style="display: flex; align-items: center; gap: 10px">
              <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
              Running validation...
            </div>
          </div>

          <!-- Streaming Validation Output -->
          <div x-show="validationOutput.length > 0" class="stream-output">
            <h4>Validation Output:</h4>
            <template x-for="(line, index) in validationOutput" :key="index">
              <div :class="getOutputLineClass(line)" x-text="line.data"></div>
            </template>
          </div>

          <!-- Validation Results -->
          <div x-show="validationCompleted && apiResults.validationResult && apiResults.validationResult.success" class="success-box">
            <strong>✅ Package Validation Successful, you can preceed to the next step.</strong><br />
          </div>

          <div x-show="validationCompleted && apiResults.validationResult && !apiResults.validationResult.success" class="warning-box">
            <strong>❌ Package Validation Failed</strong><br />
            Error:
            <span x-text="apiResults.validationResult && apiResults.validationResult.message || 'Unknown error'"></span><br />
            <div
              x-show="apiResults.validationResult && apiResults.validationResult.validation_command"
              style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-family: monospace; font-size: 12px"
            >
              <strong>Executed Command:</strong><br />
              <span x-text="apiResults.validationResult && apiResults.validationResult.validation_command"></span>
            </div>
            <div x-show="apiResults.validationResult && apiResults.validationResult.validation_output">
              Output:
              <pre style="font-size: 12px; margin-top: 10px" x-text="apiResults.validationResult && apiResults.validationResult.validation_output"></pre>
            </div>
          </div>

          <div x-show="validationCompleted && validationSuccess === 'no'">
            <div class="command-box">
              <span x-text="'spack uninstall -y --all --dependents ' + getRecipeName()"></span>
              <button class="play-btn" @click="runSpackUninstallAll()" :disabled="apiStates.uninstallingPackage">
                <span x-show="!apiStates.uninstallingPackage">Run</span>
                <span x-show="apiStates.uninstallingPackage">Uninstalling...</span>
              </button>
            </div>

            <div x-show="apiResults.uninstallResult && apiResults.uninstallResult.success" class="success-box"><strong>✅ Package Uninstalled Successfully!</strong><br /></div>
            <div x-show="apiResults.uninstallResult && !apiResults.uninstallResult.success" class="warning-box">
              <strong>❌ Package Uninstall Failed</strong><br />
              Error:
              <span x-text="apiResults.uninstallResult && apiResults.uninstallResult.message"></span>
            </div>

            <div class="warning-box">
              <strong>Validation Failed:</strong><br />
              • Check import paths<br />
              • Verify package installation<br />
              • Fix missing runtime dependencies<br /><br />
              Fix the recipe in the previous step and rebuild.
            </div>
          </div>
        </div>
      </div>

      <!-- Step 6: Create PR -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 6 }">
        <h2 class="step-title">Step 6: Create Pull Request</h2>

        <div class="success-box">🎉 Congratulations! Your package builds and validates successfully.</div>

        <div class="info-box">Now prepare a pull request by cloning the repository, copying your changes, and pushing a new branch:</div>

        <div class="command-box">
          <span style="white-space: pre-line" x-text="getPrCommands()"></span>
          <button class="play-btn" @click="runCreatePullRequest()" :disabled="apiStates.creatingPR">
            <span x-show="!apiStates.creatingPR">Run</span>
            <span x-show="apiStates.creatingPR">Creating...</span>
          </button>
        </div>

        <div x-show="apiResults.prResult && apiResults.prResult.success" class="success-box">
          <strong>✅ Pull Request Prepared Successfully!</strong><br />
          Package:
          <span x-text="apiResults.prResult && apiResults.prResult.package_name"></span><br />
          Branch:
          <span x-text="apiResults.prResult && apiResults.prResult.branch_name"></span><br />
          Branch URL:
          <a
            :href="'https://github.com/wtsi-hgi/spack-repo/tree/' + (apiResults.prResult && apiResults.prResult.branch_name)"
            target="_blank"
            style="color: #333; text-decoration: underline"
            x-text="'https://github.com/wtsi-hgi/spack-repo/tree/' + (apiResults.prResult && apiResults.prResult.branch_name)"
          ></a
          ><br />
        </div>

        <div x-show="apiResults.prResult && !apiResults.prResult.success" class="warning-box">
          <strong>❌ Pull Request Preparation Failed</strong><br />
          Error:
          <span x-text="apiResults.prResult && apiResults.prResult.message"></span>
          <div
            x-show="apiResults.prResult && apiResults.prResult.git_commands"
            style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-family: monospace; font-size: 12px"
          >
            <strong>Git Commands Executed:</strong><br />
            <template x-for="(command, index) in apiResults.prResult && apiResults.prResult.git_commands" :key="index">
              <div style="margin: 2px 0" x-text="command"></div>
            </template>
          </div>
        </div>

        <div class="warning-box">
          <strong>⚠️ Important: Collaborator Access Required</strong><br />
          To create a pull request, you need collaborator access to the spack-repo repository.
          <br /><br />
          <strong>Do you have collaborator access?</strong>
          <div class="radio-group" style="margin-top: 10px">
            <div class="radio-option">
              <input type="radio" id="access-yes" x-model="hasCollaboratorAccess" value="yes" />
              <label for="access-yes">Yes, I have access</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="access-no" x-model="hasCollaboratorAccess" value="no" />
              <label for="access-no">No, I need to request access</label>
            </div>
          </div>

          <!-- Access Request Form -->
          <div x-show="hasCollaboratorAccess === 'no'" style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px">
            <strong>Request Collaborator Access</strong><br /><br />
            Please provide your GitHub username to request access to the spack-repo:

            <div class="input-group" style="margin-top: 15px">
              <label for="githubUsername">GitHub Username:</label>
              <input
                type="text"
                id="githubUsername"
                x-model="githubUsername"
                placeholder="e.g., johndoe"
                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px"
              />
            </div>

            <button class="btn btn-warning" @click="requestCollaboratorAccess()" :disabled="!githubUsername.trim() || apiStates.requestingAccess" style="margin-top: 10px">
              <span x-show="!apiStates.requestingAccess">Request Access</span>
              <span x-show="apiStates.requestingAccess">Sending Request...</span>
            </button>

            <div x-show="apiResults.accessRequestResult" style="margin-top: 15px">
              <div x-show="apiResults.accessRequestResult && apiResults.accessRequestResult.success" class="success-box" style="margin: 0">
                <strong>✅ Access Request Sent Successfully!</strong><br />
                An email has been sent to HGI Service Desk requesting collaborator access for
                <strong x-text="githubUsername"></strong>. <br /><br />
                Once your access is granted, we will proceed with creating your pull request. You can create any future pull requests on your own.
              </div>
              <div x-show="apiResults.accessRequestResult && !apiResults.accessRequestResult.success" class="warning-box" style="margin: 0">
                <strong>❌ Access Request Failed</strong><br />
                Error:
                <span x-text="apiResults.accessRequestResult && apiResults.accessRequestResult.message"></span>
                <br /><br />
                Please contact HGI Service Desk directly at hgi@sanger.ac.uk
              </div>
            </div>
          </div>

          <!-- Proceed with PR creation -->
          <div x-show="hasCollaboratorAccess === 'yes'" style="margin-top: 20px">
            <div class="success-box" style="margin: 0">✅ Great! You have collaborator access. You can proceed with creating the pull request.</div>
          </div>
        </div>

        <div x-show="apiResults.prResult && apiResults.prResult.success && hasCollaboratorAccess === 'yes'" class="success-box">
          <strong>Next step:</strong> Click the link below to create the pull request on GitHub<br />
          <br />
          <a :href="apiResults.prResult && apiResults.prResult.pr_url" target="_blank" class="btn btn-success" style="display: inline-block; text-decoration: none; margin-top: 10px">
            🚀 Create Pull Request on GitHub
          </a>
          <br /><br />
          <small style="color: #666">Or copy this URL: <code x-text="apiResults.prResult && apiResults.prResult.pr_url"></code></small>
        </div>

        <div class="warning-box" x-show="hasCollaboratorAccess === 'yes'">
          <strong>Final Steps:</strong><br />
          1. Click the "Create Pull Request" button above<br />
          2. Review the changes on GitHub<br />
          3. Wait for GitHub Actions validation<br />
          4. Address any review comments<br />
          5. Merge when approved!
        </div>
      </div>

      <!-- Navigation -->
      <div x-show="sessionId" class="navigation">
        <button class="btn btn-secondary" @click="previousStep()" :disabled="currentStep === 1">Previous</button>

        <button class="btn" @click="nextStep()" :disabled="!canProceed() || apiStates.creatingRecipe">
          <span x-show="!apiStates.creatingRecipe" x-text="currentStep === totalSteps ? 'Finish' : 'Next'"></span>
          <span x-show="apiStates.creatingRecipe">Processing...</span>
        </button>
      </div>

      <!-- Debug Session Info -->
      <div x-show="sessionId" style="position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #999; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 3px">
        Session: <span x-text="sessionId"></span>
      </div>
    </div>
  </body>
</html>
