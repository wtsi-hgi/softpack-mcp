<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spack Package Creation Wizard</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📦</text></svg>">
    <script src="app.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- ACE Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-github.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-whitespace.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- head scripts/styles only; app logic lives in app.js -->
  </head>
  <body>
    <div class="header">
      <h1>Spack Package Creation Guide</h1>
      <p>Step-by-step workflow for creating Spack packages</p>
    </div>

    <div class="wizard-container" x-data="wizardApp()" x-init="init()">
      <!-- Notification System -->
      <div class="notifications-container">
        <template x-for="notification in notifications" :key="notification.id">
          <div class="notification" :class="notification.type">
            <button class="close-btn" @click="removeNotification(notification.id)">&times;</button>
            <div x-text="notification.message"></div>
          </div>
        </template>
      </div>
      <!-- Session Management -->
      <div x-show="!sessionId && !showSessionChoice" style="text-align: center; padding: 80px 40px">
        <h2 style="font-size: 2.5rem; font-weight: 300; margin-bottom: 20px; color: #333">Welcome! 👋</h2>
        <p style="font-size: 1.2rem; color: #666; margin-bottom: 40px; line-height: 1.6">Create and manage Spack packages with ease.</p>
        <button class="btn btn-success" @click="createSession()" :disabled="apiStates.creatingSession" style="font-size: 16px; padding: 15px 30px">
          <span x-show="!apiStates.creatingSession">Start</span>
          <span x-show="apiStates.creatingSession">Starting...</span>
        </button>
      </div>

      <!-- Session Recovery Choice -->
      <div x-show="!sessionId && showSessionChoice" style="text-align: center; padding: 80px 40px">
        <h2 style="font-size: 2.5rem; font-weight: 300; margin-bottom: 20px; color: #333">Welcome Back! 👋</h2>
        <p style="font-size: 1.2rem; color: #666; margin-bottom: 40px; line-height: 1.6">
          We found an existing session from your last visit.<br/>
          <strong>Package:</strong> <span x-text="existingSessionData?.packageName || 'Unknown'"></span><br/>
          <strong>Step:</strong> <span x-text="existingSessionData?.currentStep || 1"></span> of 5<br/>
          <strong>Last updated:</strong> <span x-text="new Date(existingSessionData?.timestamp).toLocaleString()"></span>
        </p>

        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-success" @click="recoverSession()" style="font-size: 16px; padding: 15px 30px">
            🔄 Recover Last Session
          </button>
          <button class="btn btn-secondary" @click="startNewSession()" style="font-size: 16px; padding: 15px 30px">
            🆕 Start New Session
          </button>
        </div>

        <p style="font-size: 0.9rem; color: #999; margin-top: 30px; line-height: 1.4">
          <strong>Recover Last Session:</strong> Continue where you left off with all your previous work.<br/>
          <strong>Start New Session:</strong> Begin fresh with a clean slate.
        </p>
      </div>

      <!-- Progress Bar -->
      <div x-show="sessionId" class="progress-bar">
        <div class="progress-fill" :style="`width: ${(currentStep / totalSteps) * 100}%`"></div>
      </div>

      <!-- Step 1: Package Information -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 1 }">
        <h2 class="step-title">Step 1: Package Information</h2>

        <div class="input-group">
          <label for="packageName">Package Name: <span style="color: #dc3545;">*</span></label>
          <input
            type="text"
            id="packageName"
            x-model="packageName"
            placeholder="e.g., numpy, ggplot2, cmake, fastapi"
            :class="packageName.trim() === '' ? 'invalid-input' : ''"
            title="Please enter a package name to continue"
          />
          <div x-show="step1ValidationAttempted && packageName.trim() === ''" class="error-message">
            Package name is required
          </div>
          <div x-show="packageName && (packageName.includes('.') || packageName.includes('_') || packageName.toLowerCase() !== packageName)" class="warning-box" style="margin-top: 10px; padding: 10px; font-size: 13px;">
            <strong>Note:</strong> Spack recipe names convert . or _ to -, and convert uppercase to lowercase.<br/>
         </div>
        </div>

        <div class="input-group">
          <label for="packageType">Package Type: <span style="color: #dc3545;">*</span></label>
          <select
            id="packageType"
            x-model="packageType"
            :class="packageType === '' ? 'invalid-input' : ''"
            title="Please select a package type to continue"
          >
            <option value="">Select package type...</option>
            <option value="python">Python Package</option>
            <option value="r">R Package</option>
            <option value="other">Other Package</option>
          </select>
          <div x-show="step1ValidationAttempted && packageType === ''" class="error-message">
            Package type is required
          </div>
        </div>


        <div class="info-box" x-show="packageName">
          Spack Recipe Name: <strong x-text="getRecipeName()"></strong>
        </div>


      </div>



      <!-- Step 2a: Existing Recipe - Version Check -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 2 && recipeExists === 'yes' }">
        <h2 class="step-title">Step 2: Recipe Exists - Version Management</h2>

        <div class="success-box">✅ Recipe found in spack-repo! The package <strong x-text="getRecipeName()"></strong> already exists.</div>

        <div class="input-group">
          <label>Do you need a specific version?</label>
          <div class="radio-group">
            <button
              type="button"
              class="btn"
              :class="{ 'btn-success': needsSpecificVersion === 'yes', 'btn-secondary': needsSpecificVersion !== 'yes' }"
              @click="needsSpecificVersion = 'yes'"
            >
              Yes, need specific version
            </button>
            <button
              type="button"
              class="btn"
              :class="{ 'btn-success': needsSpecificVersion === 'no', 'btn-secondary': needsSpecificVersion !== 'no' }"
              @click="needsSpecificVersion = 'no'"
            >
              No, use existing
            </button>
          </div>
        </div>

        <div x-show="needsSpecificVersion === 'yes'">
          <div class="info-box">First run checksum to get all the available versions:</div>
          <div class="command-box">
            <span x-text="'spack checksum -b ' + getRecipeName()"></span>
            <button class="play-btn" @click="runSpackChecksum()" :disabled="apiStates.runningChecksum">
              <span x-show="!apiStates.runningChecksum">Run</span>
              <span x-show="apiStates.runningChecksum">Running...</span>
            </button>
          </div>

          <div class="input-group">
            <label for="newVersion">Enter the new version to add:</label>
            <input type="text" id="newVersion" x-model="newVersion" placeholder="e.g., 1.2.3" />
          </div>

          <div x-show="apiResults.checksums" class="success-box">
            <strong>Available Checksums:</strong>
            <div x-show="apiResults.checksums && apiResults.checksums.success">
              <!-- Show specific version checksum first if specified -->
              <div x-show="newVersion && apiResults.checksums && apiResults.checksums.checksums && apiResults.checksums.checksums[newVersion]" style="margin-bottom: 15px">
                <strong>Checksum for version <span x-text="newVersion"></span>:</strong>
                <div class="command-box" style="margin: 10px 0; background: #e8f5e8">
                  <span style="font-family: monospace; font-size: 13px; color: #155724" x-text="getVersionCommand()"></span>
                  <button class="copy-btn" @click="copyToClipboard(getVersionCommand())" style="background: #28a745">Copy</button>
                </div>
              </div>

              <div x-data="{ showAllChecksums: false }">
                <button @click="showAllChecksums = !showAllChecksums" class="btn btn-secondary">
                  <span x-text="showAllChecksums ? 'Hide All Checksums' : 'Show All Checksums'"></span>
                </button>
                <div x-show="showAllChecksums" style="margin-top: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto">
                  <template x-for="[version, checksum] in Object.entries(apiResults.checksums && apiResults.checksums.checksums || {})">
                    <div style="margin: 5px 0; padding: 5px; border-radius: 3px" :style="version === newVersion ? 'background-color: #fff3cd; border: 1px solid #ffeaa7;' : ''">
                      <div
                        style="cursor: pointer; background: none; border: none; padding: 0; color: inherit; font: inherit; text-align: left"
                        @click='copyToClipboard("version(\"" + version + "\", sha256=\"" + checksum + "\")")'
                        title="Click to copy"
                      >
                        version(<span x-text="version"></span>, sha256=<span x-text="checksum"></span>)
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <div x-show="apiResults.checksums && !apiResults.checksums.success" class="warning-box">
              Error:
              <span x-text="apiResults.checksums && apiResults.checksums.message"></span>
            </div>
          </div>

          <div x-show="apiResults.checksums && apiResults.checksums.success" class="warning-box">
            <strong>Manual Step:</strong> Copy the line above and edit the recipe file in the next step to add the new version and SHA256 checksum. If your new version is not in the list, you can add it manually.
          </div>
        </div>

        <div x-show="needsSpecificVersion === 'no'">
          <div class="success-box">✅ Great! You can use the existing recipe as-is. Proceed to installation testing.</div>
        </div>
      </div>

      <!-- Step 2b: New Recipe Creation -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 2 && recipeExists === 'no' }">
        <h2 class="step-title">Step 2: Create New Recipe</h2>

        <div x-show="apiStates.autoCreatingRecipe" class="info-box">
          <div style="display: flex; align-items: center; gap: 10px">
            <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
            <span x-show="packageType === 'python' && apiStates.checkingPypi">Checking PyPI for <strong x-text="pypiName"></strong>...</span>
            <span x-show="packageType === 'python' && !apiStates.checkingPypi && apiStates.creatingPypi">Creating Python package from PyPI...</span>
            <span x-show="!apiStates.checkingPypi && !apiStates.creatingPypi && officialChecking">Checking official Spack repository...</span>
            <span x-show="!apiStates.checkingPypi && !apiStates.creatingPypi && !officialChecking && apiStates.copyingPackage">Copying recipe from official repository...</span>
          </div>
        </div>

        <!-- Manual Creation Options (only shown if auto-creation failed) -->
        <div x-show="!apiStates.autoCreatingRecipe && !(apiResults.pypiResult && apiResults.pypiResult.success) && !(apiResults.copyResult && apiResults.copyResult.success)">
          <div x-show="packageType === 'python'">
            <div class="info-box">For Python packages, try the automated PyPackageCreator:</div>

            <div class="command-box">
              <span style="white-space: pre-line" x-text="getPyPackageCreatorCommand()"></span>
              <button class="play-btn" @click="runPyPackageCreator()" :disabled="apiStates.creatingPypi">
                <span x-show="!apiStates.creatingPypi">Run</span>
                <span x-show="apiStates.creatingPypi">Creating...</span>
              </button>
            </div>

            <div x-show="apiResults.pypiResult && apiResults.pypiResult.success" class="success-box">
              <strong>✅ PyPI Package Created Successfully!</strong><br />
            </div>
            <div x-show="apiResults.pypiResult && !apiResults.pypiResult.success" class="warning-box">
              <strong>❌ PyPI Package Creation Failed</strong><br />
              Error:
              <span x-text="apiResults.pypiResult && apiResults.pypiResult.message"></span>
            </div>
          </div>

          <div x-show="packageType !== 'python' || (apiResults.pypiResult && !apiResults.pypiResult.success)">
            <div class="info-box">Let's check the official Spack repository and create a recipe:</div>

            <div x-show="officialChecking" class="info-box">
              <div style="display: flex; align-items: center; gap: 10px">
                <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
                Checking official Spack repository for
                <strong x-text="packageName"></strong>...
              </div>
            </div>

            <div x-show="!officialChecking && foundInOfficial === 'yes'" class="success-box">✅ Package found in official Spack repository! The create command will copy the existing recipe.</div>

            <div x-show="!officialChecking && foundInOfficial === 'no'" class="warning-box">❌ Package not found in official Spack repository. You'll need to create a recipe manually.</div>

            <div x-show="foundInOfficial === 'yes'" class="command-box">
              <span x-text="'create ' + getRecipeName()"></span>
              <button class="play-btn" @click="runCopyPackage()" :disabled="apiStates.copyingPackage">
                <span x-show="!apiStates.copyingPackage">Run</span>
                <span x-show="apiStates.copyingPackage">Copying...</span>
              </button>
            </div>

            <div x-show="apiResults.copyResult && !apiResults.copyResult.success" class="warning-box">
              <strong>❌ Package Copy Failed</strong><br />
              Error:
              <span x-text="apiResults.copyResult && apiResults.copyResult.message"></span>
            </div>

            <div x-show="foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success">
              <div class="success-box">
                ✅ Excellent! The official recipe has been copied as a base. You can modify it as needed.
                <br /><br />
              </div>
            </div>

            <div x-show="foundInOfficial === 'no'">
              <div class="input-group">
                <label>Does the project have GitHub releases/tags/commit?</label>
                <div class="radio-group">
                  <button
                    type="button"
                    class="btn"
                    :class="{ 'btn-success': hasReleases === 'yes', 'btn-secondary': hasReleases !== 'yes' }"
                    @click="hasReleases = 'yes'"
                  >
                    Yes, has releases/tags
                  </button>
                  <button
                    type="button"
                    class="btn"
                    :class="{ 'btn-success': hasReleases === 'no', 'btn-secondary': hasReleases !== 'no' }"
                    @click="hasReleases = 'no'"
                  >
                    No releases, use latest commit
                  </button>
                  <button
                    type="button"
                    class="btn"
                    :class="{ 'btn-success': hasReleases === 'nothing', 'btn-secondary': hasReleases !== 'nothing' }"
                    @click="hasReleases = 'nothing'"
                  >
                    Nothing, create blank template
                  </button>
                </div>
              </div>

              <div x-show="hasReleases === 'yes'">
                <div class="input-group">
                  <label for="releaseUrl">Release Archive URL:</label>
                  <input
                    type="url"
                    id="releaseUrl"
                    x-model="releaseUrl"
                    placeholder="https://github.com/owner/repo/archive/refs/tags/v1.0.0.tar.gz"
                    :class="releaseUrl && !isValidReleaseUrl(releaseUrl) ? 'invalid-input' : ''"
                  />
                  <div x-show="releaseUrl && !isValidReleaseUrl(releaseUrl)" class="error-message">
                    Please enter a valid release archive URL (e.g., .tar.gz, .zip, or GitHub/GitLab archive URL)
                  </div>
                </div>

                <div class="command-box" x-show="releaseUrl && isValidReleaseUrl(releaseUrl)">
                  <span x-text="'spack create --skip-editor -b ' + releaseUrl"></span>
                  <button class="play-btn" @click="runCreateFromUrl()" :disabled="apiStates.creatingFromUrl">
                    <span x-show="!apiStates.creatingFromUrl">Run</span>
                    <span x-show="apiStates.creatingFromUrl">Creating...</span>
                  </button>
                </div>

                <div x-show="apiResults.urlResult && apiResults.urlResult.success" class="success-box"><strong>✅ Recipe Created from URL</strong><br /></div>
                <div x-show="apiResults.urlResult && !apiResults.urlResult.success" class="warning-box">
                  <strong>❌ Recipe Creation Failed</strong><br />
                  Error:
                  <span x-text="apiResults.urlResult && apiResults.urlResult.message"></span>
                </div>
              </div>

              <div x-show="hasReleases === 'no'">
                <div class="input-group">
                  <label for="repoUrl">Repository URL:</label>
                  <input
                    type="url"
                    id="repoUrl"
                    x-model="repoUrl"
                    placeholder="https://github.com/owner/repo"
                    :class="repoUrl && !isValidRepoUrl(repoUrl) ? 'invalid-input' : ''"
                  />
                  <div x-show="repoUrl && !isValidRepoUrl(repoUrl)" class="error-message">
                    Please enter a valid repository URL (e.g., GitHub, GitLab, or Bitbucket repository)
                  </div>
                </div>

                <div class="command-box" x-show="repoUrl && isValidRepoUrl(repoUrl)">
                  <span style="white-space: pre-line" x-text="getCommitCommands()"></span>
                  <button class="play-btn" @click="runGetCommitInfo()" :disabled="apiStates.gettingCommitInfo">
                    <span x-show="!apiStates.gettingCommitInfo">Run</span>
                    <span x-show="apiStates.gettingCommitInfo">Getting...</span>
                  </button>
                </div>

                <div x-show="apiResults.commitInfo && apiResults.commitInfo.success" class="success-box">
                  <strong>✅ Git Commit Info Retrieved!</strong><br />
                  Commit:
                  <span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_hash"></span><br />
                  Date:
                  <span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_date"></span><br />
                  <br />
                  <strong>Added to recipe:</strong><br />
                  <code
                    >version("<span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_date"></span>", commit="<span x-text="apiResults.commitInfo && apiResults.commitInfo.commit_hash"></span
                    >")</code
                  >
                </div>
                <div x-show="apiResults.commitInfo && !apiResults.commitInfo.success" class="warning-box">
                  <strong>❌ Failed to Get Commit Info</strong><br />
                  Error:
                  <span x-text="apiResults.commitInfo && apiResults.commitInfo.message"></span>
                </div>
              </div>

              <div x-show="hasReleases === 'nothing'">
                <div class="info-box">Creating a blank template recipe using spack create:</div>

                <div class="command-box">
                  <span x-text="'spack create --skip-editor ' + getRecipeName()"></span>
                  <button class="play-btn" @click="runCreateBlankRecipe()" :disabled="apiStates.creatingBlankRecipe">
                    <span x-show="!apiStates.creatingBlankRecipe">Run</span>
                    <span x-show="apiStates.creatingBlankRecipe">Creating...</span>
                  </button>
                </div>

                <div x-show="apiResults.blankRecipeResult && apiResults.blankRecipeResult.success" class="success-box">
                  <strong>✅ Blank Template Recipe Created!</strong><br />
                </div>
                <div x-show="apiResults.blankRecipeResult && !apiResults.blankRecipeResult.success" class="warning-box">
                  <strong>❌ Blank Recipe Creation Failed</strong><br />
                  Error:
                  <span x-text="apiResults.blankRecipeResult && apiResults.blankRecipeResult.message"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recipe Created Successfully - Version Management Options -->
        <div x-show="!apiStates.autoCreatingRecipe && ((apiResults.pypiResult && apiResults.pypiResult.success) || (apiResults.copyResult && apiResults.copyResult.success))" class="success-box">
          <strong>✅ Recipe Created Successfully!</strong><br />
          <div style="margin-top: 15px;">
            <div class="input-group">
              <label>Do you need to add a specific version to the recipe?</label>
              <div class="radio-group">
                <button
                  type="button"
                  class="btn"
                  :class="{ 'btn-success': needsSpecificVersion === 'yes', 'btn-secondary': needsSpecificVersion !== 'yes' }"
                  @click="needsSpecificVersion = 'yes'"
                >
                  Yes, add a new version
                </button>
                <button
                  type="button"
                  class="btn"
                  :class="{ 'btn-success': needsSpecificVersion === 'no', 'btn-secondary': needsSpecificVersion !== 'no' }"
                  @click="needsSpecificVersion = 'no'"
                >
                  No, proceed to editor
                </button>
              </div>
            </div>

            <div x-show="needsSpecificVersion === 'yes'" style="margin-top: 15px;">
              <div class="input-group">
                <label for="newVersionNew">New Version:</label>
                <input type="text" id="newVersionNew" x-model="newVersion" placeholder="e.g., 1.2.3" />
              </div>

              <div class="command-box">
                <span x-text="'spack checksum -b ' + getRecipeName()"></span>
                <button class="play-btn" @click="runSpackChecksum()" :disabled="apiStates.runningChecksum">
                  <span x-show="!apiStates.runningChecksum">Run</span>
                  <span x-show="apiStates.runningChecksum">Running...</span>
                </button>
              </div>

              <div x-show="apiResults.checksums && apiResults.checksums.success" class="success-box">
                <!-- Show specific version checksum first if specified -->
                <div x-show="newVersion && apiResults.checksums && apiResults.checksums.checksums && apiResults.checksums.checksums[newVersion]" style="margin-bottom: 15px">
                  <strong>Checksum for version <span x-text="newVersion"></span>:</strong>
                  <div class="command-box" style="margin: 10px 0; background: #e8f5e8">
                    <span style="font-family: monospace; font-size: 13px; color: #155724" x-text="getVersionCommand()"></span>
                    <button class="copy-btn" @click="copyToClipboard(getVersionCommand())" style="background: #28a745">Copy</button>
                  </div>
                </div>

                <div x-data="{ showAllChecksums: false }">
                  <button @click="showAllChecksums = !showAllChecksums" class="btn btn-secondary">
                    <span x-text="showAllChecksums ? 'Hide All Checksums' : 'Show All Checksums'"></span>
                  </button>
                  <div x-show="showAllChecksums" style="margin-top: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto">
                    <template x-for="[version, checksum] in Object.entries(apiResults.checksums && apiResults.checksums.checksums || {})">
                      <div style="margin: 5px 0; padding: 5px; border-radius: 3px" :style="version === newVersion ? 'background-color: #fff3cd; border: 1px solid #ffeaa7;' : ''">
                        <div
                          style="cursor: pointer; background: none; border: none; padding: 0; color: inherit; font: inherit; text-align: left"
                          @click='copyToClipboard("version(\"" + version + "\", sha256=\"" + checksum + "\")")'
                          title="Click to copy"
                        >
                          version(<span x-text="version"></span>, sha256=<span x-text="checksum"></span>)
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
              <div x-show="apiResults.checksums && !apiResults.checksums.success" class="warning-box">
                Error:
                <span x-text="apiResults.checksums && apiResults.checksums.message"></span>
              </div>

              <div x-show="apiResults.checksums && apiResults.checksums.success" class="warning-box">
                <strong>Manual Step:</strong> Edit the recipe file in the next step to add the new version and SHA256 checksum from the output above.
              </div>
            </div>

            <div x-show="needsSpecificVersion === 'no'" style="margin-top: 15px;">
              <div class="success-box">✅ Great! You can use the existing recipe as-is. Proceed to the recipe editor.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Recipe Modification -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 3 }">
        <h2 class="step-title">Step 3: Gather Info and Modify Recipe</h2>

        <div x-show="packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success" class="success-box">✅ <strong>PyPackageCreator was used successfully!</strong><br/>Recipe was automatically created and you can now edit it below.</div>

        <div x-show="foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success" class="success-box">✅ <strong>Official recipe was copied successfully!</strong><br/>Recipe was automatically copied and you can now edit it below.</div>

        <div x-show="hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success" class="success-box">
          ✅ <strong>Blank template recipe was created successfully!</strong>
        </div>

        <div
          x-show="!(apiResults.pypiResult && apiResults.pypiResult.success) && !(foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success) && !(hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success)"
          class="info-box"
        >
          Now you need to research the package and add proper dependencies to the recipe.
        </div>

        <!-- Recipe Editor Section -->
        <div style="margin-bottom: 30px">
          <!-- Recipe Selection Menu -->
          <div style="margin-bottom: 20px">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
              <label style="font-weight: 500; color: #333; font-size: 16px">Select Recipe to Edit:</label>
              <button class="btn btn-secondary" @click="loadRecipes()" :disabled="apiStates.loadingRecipes" style="padding: 8px 16px; font-size: 12px">
                <span x-show="!apiStates.loadingRecipes">Refresh Recipes</span>
                <span x-show="apiStates.loadingRecipes">Loading...</span>
              </button>
            </div>

            <div x-show="apiStates.loadingRecipes" style="text-align: center; padding: 20px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa">
              <div
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  border: 2px solid #333;
                  border-top: 2px solid transparent;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                  margin-right: 10px;
                "
              ></div>
              Loading recipes...
            </div>

            <div
              x-show="!apiStates.loadingRecipes && (!apiResults.recipes || apiResults.recipes.length === 0)"
              style="text-align: center; padding: 20px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa"
            >
              No recipes found in session
            </div>

            <div x-show="!apiStates.loadingRecipes && apiResults.recipes && apiResults.recipes.length > 0">
              <select
                :value="selectedRecipe ? selectedRecipe.package_name : ''"
                @change="$event.target.value ? selectRecipe(apiResults.recipes.find(r => r.package_name === $event.target.value)) : selectRecipe(null)"
                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; background: white; box-sizing: border-box"
              >
                <option value="">Select a recipe...</option>
                <template x-for="recipe in apiResults.recipes" :key="recipe.package_name">
                  <option :value="recipe.package_name" x-text="recipe.package_name + (recipe.exists ? ' ✓' : ' ✗') + (recipe.package_name === getRecipeName() ? ' (Current Package)' : '') + (apiResults.pypiResult && apiResults.pypiResult.moved_packages && apiResults.pypiResult.moved_packages.find(p => p.name === recipe.package_name) ? (recipe.package_name === 'py-' + packageName ? ' (Main)' : ' (Dependency)') : '')"></option>
                </template>
              </select>

              <!-- Selected Recipe Info -->
              <div x-show="selectedRecipe" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 4px; font-size: 13px">
                <strong x-text="selectedRecipe && selectedRecipe.package_name"></strong>
                <span style="color: #666; margin-left: 10px" x-text="selectedRecipe && selectedRecipe.file_path"></span>
                <span x-show="selectedRecipe && selectedRecipe.size" style="color: #999; margin-left: 10px" x-text="selectedRecipe && '(' + (selectedRecipe.size / 1024).toFixed(1) + ' KB)'"></span>
              </div>

              <!-- Multiple Recipes Info -->
              <div x-show="apiResults.pypiResult && apiResults.pypiResult.moved_packages && apiResults.pypiResult.moved_packages.length > 1" style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px">
                <strong>📦 Multiple Recipes Created:</strong>
                <div style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                  <template x-for="package in (apiResults.pypiResult && apiResults.pypiResult.moved_packages || [])" :key="package.name">
                    <div style="margin: 2px 0; padding: 2px 0;">
                      <span x-text="package.name" :style="package.name === 'py-' + packageName ? 'font-weight: bold; color: #155724;' : 'color: #856404;'"></span>
                      <span x-show="package.name === 'py-' + packageName" style="color: #155724; margin-left: 5px;">(Main Package)</span>
                      <span x-show="package.name !== 'py-' + packageName" style="color: #856404; margin-left: 5px;">(Dependency)</span>
                    </div>
                  </template>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #856404;">
                  All recipes are available in the dropdown above. The main package is automatically selected.
                </div>
              </div>

              <!-- Copied Files Info -->
              <div x-show="apiResults.copyResult && apiResults.copyResult.copied_files && apiResults.copyResult.copied_files.length > 0" style="margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 13px">
                <strong>📁 Files Copied from Repository:</strong>
                <div style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                  <template x-for="file in (apiResults.copyResult && apiResults.copyResult.copied_files || [])" :key="file">
                    <div style="margin: 2px 0; padding: 2px 0; color: #0c5460;">
                      <span x-text="file"></span>
                    </div>
                  </template>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #0c5460;">
                  All files (including patch files) have been copied to the recipe directory.
                </div>
              </div>
            </div>
          </div>

          <!-- Recipe Editor -->
          <div style="width: 100%">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
              <strong style="font-size: 16px; color: #333">Recipe Editor</strong>
            </div>

            <div x-show="!selectedRecipe" style="text-align: center; padding: 60px; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa; font-size: 16px">
              Select a recipe from the dropdown above to start editing
            </div>

            <div x-show="selectedRecipe && currentStep === 3" style="width: 100%">
              <div class="ace-editor-container">
                <div class="ace-editor-toolbar">
                  <div class="ace-editor-info">
                    <span>Python Recipe Editor</span>
                    <span x-show="selectedRecipe" x-text="'Editing: ' + (selectedRecipe ? selectedRecipe.package_name : '')"></span>
                    <span x-show="aceEditor" x-text="'Line ' + editorCursorInfo.row + ', Col ' + editorCursorInfo.column + ' • ' + editorCursorInfo.lines + ' lines'"></span>
                  </div>
                  <div class="ace-editor-shortcuts">
                    <span>Ctrl+S / Cmd+S to save & validate</span>
                    <span style="margin-left: 15px; color: #999;">•</span>
                    <span style="margin-left: 5px;">Tabs & spaces visible</span>
                  </div>
                </div>
                <div
                  id="ace-recipe-editor"
                  class="ace-editor"
                  x-init="
                    if (currentStep === 3) {
                      $nextTick(() => {
                        setTimeout(() => {
                          if (!aceEditor && document.getElementById('ace-recipe-editor')) {
                            initializeAceEditor();
                          }
                        }, 100);
                      });
                    }
                  "
                ></div>
              </div>

              <!-- Validation Results -->
              <div x-show="validationResult" style="margin-top: 20px">
                <div :class="validationResult && validationResult.is_valid ? 'success-box' : 'warning-box'">
                  <div style="font-weight: 500; font-size: 16px">
                    <span x-show="validationResult && validationResult.is_valid">✅ Valid Recipe</span>
                    <span x-show="validationResult && !validationResult.is_valid">❌ Invalid Recipe</span>
                  </div>
                  <div x-show="validationResult && validationResult.errors && validationResult.errors.length > 0" style="margin-top: 15px">
                    <div style="font-weight: 500; color: #dc3545; font-size: 14px">Errors:</div>
                    <ul style="margin: 8px 0; padding-left: 20px">
                      <template x-for="error in (validationResult && validationResult.errors || [])" :key="error">
                        <li style="color: #dc3545; font-size: 14px; margin: 4px 0" x-text="error"></li>
                      </template>
                    </ul>
                  </div>
                  <div x-show="validationResult && validationResult.warnings && validationResult.warnings.length > 0" style="margin-top: 15px">
                    <div style="font-weight: 500; color: #856404; font-size: 14px">Warnings:</div>
                    <ul style="margin: 8px 0; padding-left: 20px">
                      <template x-for="warning in (validationResult && validationResult.warnings || [])" :key="warning">
                        <li style="color: #856404; font-size: 14px; margin: 4px 0" x-text="warning"></li>
                      </template>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Step 3 Proceed Status -->
              <div x-show="currentStep === 3 && validationResult" style="margin-top: 20px">
                <div :class="validationResult && validationResult.is_valid ? 'success-box' : 'warning-box'" style="border-left: 4px solid #007bff;">
                  <div style="font-weight: 500; font-size: 14px; color: #333;">
                    <span x-show="validationResult && validationResult.is_valid">✅ Ready to proceed to build step</span>
                    <span x-show="validationResult && !validationResult.is_valid">❌ Cannot proceed - recipe has validation errors</span>
                  </div>
                  <div x-show="validationResult && !validationResult.is_valid" style="margin-top: 10px; font-size: 13px; color: #666;">
                    Please fix the validation errors above before proceeding to the build step.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          x-show="(packageType !== 'python' || pypiSuccess === 'no') && !(foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success) && !(hasReleases === 'nothing' && apiResults.blankRecipeResult && apiResults.blankRecipeResult.success)"
          class="warning-box"
        >
          <strong>Look at these examples for guidance:</strong><br />
          • Python:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/py-agate/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>py-agate</code></a
          ><br />
          • R:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/r-archr/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>r-archr</code></a
          >, <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/r-plotlistr/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>r-plotlistr</code></a
          ><br />
          • Other:
          <a href="https://github.com/wtsi-hgi/spack-repo/tree/main/packages/samtools/package.py" target="_blank" style="color: #333; text-decoration: underline"><code>samtools</code></a
          ><br /><br />

          Python dependencies must have type=("build", "run") on the depends_on() line.
        </div>


        <div class="input-group">
          <label>Common modifications needed:</label>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="deps"
              x-model="modifications.dependencies"
              :checked="(packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success) || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="deps">Add proper description and homepage URL</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="optional"
              x-model="modifications.optional"
              :checked="(packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success) || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="optional">Add git repository URL and license</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="patches"
              x-model="modifications.patches"
              :checked="(packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success) || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="patches">Add version with commit hash</label>
          </div>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="flags"
              x-model="modifications.buildFlags"
              :checked="(packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success) || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)"
            />
            <label for="flags">Add dependencies to depends_on()</label>
          </div>
        </div>

        <div x-show="(packageType === 'python' && apiResults.pypiResult && apiResults.pypiResult.success) || (foundInOfficial === 'yes' && apiResults.copyResult && apiResults.copyResult.success)" class="warning-box">
          <strong>⚠️ Important:</strong> Even though the recipe was automatically generated/copied with most modifications, always verify the generated recipe for syntax errors and accuracy before
          proceeding to build.
        </div>
      </div>

      <!-- Step 4: Build and Test -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 4 }">
        <h2 class="step-title">Step 4: Build and Test</h2>

        <div class="info-box">Now let's build the package and test it:</div>

        <!-- Installation Options -->
        <div class="input-group" style="margin-bottom: 20px;">
          <label for="installVersion">Install Specific Version (optional):</label>
          <input
            type="text"
            id="installVersion"
            x-model="installVersion"
            placeholder="e.g., 1.2.3 (leave empty for latest)"
            style="width: 100%;"
          />
          <small style="color: #666; font-size: 12px">Leave empty to install the latest version available in the recipe.</small>
        </div>

        <!-- Skip Installation Option -->
        <div class="warning-box" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input
              type="checkbox"
              id="skipInstallValidation"
              x-model="skipInstallValidation"
              style="margin: 0;"
            />
            <label for="skipInstallValidation" style="margin: 0; font-weight: bold; color: #856404;">
              Skip installation and validation
            </label>
          </div>
          <small style="color: #856404; font-size: 12px">
            ⚠️ Only use this if you're confident the recipe is correct. You won't know if the package builds or works properly. Use the "Next" button below to skip.
          </small>
        </div>

        <div class="command-box">
          <span x-text="'spack install ' + getRecipeName() + (installVersion ? ' @' + installVersion : '')"></span>
          <button class="play-btn" @click="runSpackInstall()" :disabled="apiStates.installingPackage">
            <span x-show="!apiStates.installingPackage">Build</span>
            <span x-show="apiStates.installingPackage">Installing...</span>
          </button>
        </div>

        <!-- Installation Output -->
        <div style="margin: 30px 0">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px">
            <strong style="font-size: 16px; color: #333">Installation Output</strong>
            <button @click="clearInstallOutput()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px">Clear Output</button>
          </div>
          <div class="stream-output">
            <template x-for="(line, index) in installOutput" :key="index">
              <div :class="getOutputLineClass(line)" x-text="line.data"></div>
            </template>
            <div x-show="installOutput.length === 0" style="color: #888; font-style: italic">Installation output will appear here...</div>
          </div>
        </div>

        <div x-show="apiResults.installResult && !apiResults.installResult.success" class="warning-box">
          <strong>❌ Package Installation Failed</strong><br />
          Error:
          <span x-text="apiResults.installResult && apiResults.installResult.message"></span>
          <br /><br />

          <!-- View Error Log Button -->
          <div x-show="apiResults.installResult && apiResults.installResult.detailed_failed_log" style="margin: 15px 0;">
            <button
              @click="showDetailedLog = !showDetailedLog"
              class="btn btn-warning"
              style="padding: 10px 20px; font-size: 14px;"
            >
              <span x-show="!showDetailedLog">📋 View Detailed Error Log</span>
              <span x-show="showDetailedLog">🔼 Hide Detailed Error Log</span>
            </button>
          </div>

          <!-- Detailed Error Log Display -->
          <div x-show="showDetailedLog && apiResults.installResult && apiResults.installResult.detailed_failed_log" style="margin-top: 15px;">
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd;">
                <strong style="color: #333; font-family: inherit;">Build Log Contents (spack-build-out.txt)</strong>
                <button
                  @click="copyToClipboard(apiResults.installResult && apiResults.installResult.detailed_failed_log || '')"
                  class="copy-btn"
                  style="font-size: 11px; padding: 4px 8px;"
                >
                  Copy All
                </button>
              </div>
              <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; color: #333;" x-text="apiResults.installResult && apiResults.installResult.detailed_failed_log || ''"></pre>
            </div>
          </div>

          <strong>Troubleshooting:</strong><br />
          • Check the installation output above for error details<br />
          • Use the "View Detailed Error Log" button above for complete build logs<br />
          • Add missing dependencies to the recipe<br />
          • Fix version constraints<br />
          • Add patches if needed<br />
          • Modify build flags<br /><br />
          Fix the recipe and try building again.
        </div>

        <div x-show="buildSuccess === 'yes'">
          <div class="success-box">✅ Build successful! Now let's validate the package:</div>

          <!-- Custom Validation Script Input -->
          <div class="input-group">
            <label for="customValidationScript">Custom Validation Script (optional):</label>
            <textarea
              id="customValidationScript"
              x-model="customValidationScript"
              rows="1"
              :placeholder="getDefaultValidationScript()"
              @focus="customValidationScript === '' ? customValidationScript = getDefaultValidationScript() : null"
            ></textarea>
            <small style="color: #666; font-size: 12px"> Leave empty to use default validation for package type. </small>
          </div>

          <!-- Validation Button -->
          <div class="command-box">
            <span x-text="getValidationCommand()"></span>
            <button class="play-btn" @click="runPackageValidationStream()" :disabled="apiStates.validatingPackage">
              <span x-show="!apiStates.validatingPackage">Validate</span>
              <span x-show="apiStates.validatingPackage">Validating...</span>
            </button>
          </div>

          <!-- Validation Status -->
          <div x-show="apiStates.validatingPackage" class="info-box">
            <div style="display: flex; align-items: center; gap: 10px">
              <div style="width: 20px; height: 20px; border: 2px solid #667eea; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite"></div>
              Running validation...
            </div>
          </div>

          <!-- Streaming Validation Output -->
          <div x-show="validationOutput.length > 0" class="stream-output">
            <h4>Validation Output:</h4>
            <template x-for="(line, index) in validationOutput" :key="index">
              <div :class="getOutputLineClass(line)" x-text="line.data"></div>
            </template>
          </div>

          <!-- Validation Results -->
          <div x-show="validationCompleted && apiResults.validationResult && apiResults.validationResult.success" class="success-box">
            <strong>✅ Package Validation Successful, you can preceed to the next step.</strong><br />
          </div>

          <div x-show="validationCompleted && apiResults.validationResult && !apiResults.validationResult.success" class="warning-box">
            <strong>❌ Package Validation Failed</strong><br />
            Error:
            <span x-text="apiResults.validationResult && apiResults.validationResult.message || 'Unknown error'"></span><br />
            <div
              x-show="apiResults.validationResult && apiResults.validationResult.validation_command"
              style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-family: monospace; font-size: 12px"
            >
              <strong>Executed Command:</strong><br />
              <span x-text="apiResults.validationResult && apiResults.validationResult.validation_command"></span>
            </div>
            <div x-show="apiResults.validationResult && apiResults.validationResult.validation_output">
              Output:
              <pre style="font-size: 12px; margin-top: 10px" x-text="apiResults.validationResult && apiResults.validationResult.validation_output"></pre>
            </div>
          </div>

          <div x-show="validationCompleted && validationSuccess === 'no'">
            <div class="warning-box">
              <strong>Validation Failed:</strong><br />
              • Check import paths<br />
              • Verify package installation<br />
              • Fix missing runtime dependencies<br /><br />
              Fix the recipe in the previous step and rebuild.
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Create PR -->
      <div x-show="sessionId" class="step" :class="{ active: currentStep === 5 }">
        <h2 class="step-title">Step 5: Create Pull Request</h2>

        <div class="success-box">
          <span x-show="!skipInstallValidation">🎉 Congratulations! Your package builds and validates successfully.</span>
          <span x-show="skipInstallValidation">🎉 Package recipe created successfully. Installation and validation were skipped.</span>
        </div>

        <div class="info-box">Now prepare a pull request by cloning the repository, copying your changes, and pushing a new branch:</div>

        <div class="command-box">
          <span style="white-space: pre-line" x-text="getPrCommands()"></span>
          <button class="play-btn" @click="runCreatePullRequest()" :disabled="apiStates.creatingPR">
            <span x-show="!apiStates.creatingPR">Run</span>
            <span x-show="apiStates.creatingPR">Creating...</span>
          </button>
        </div>

        <div x-show="apiResults.prResult && apiResults.prResult.success" class="success-box">
          <strong>✅ Pull Request Prepared Successfully!</strong><br />
          Package:
          <span x-text="apiResults.prResult && apiResults.prResult.package_name"></span><br />
          Branch:
          <span x-text="apiResults.prResult && apiResults.prResult.branch_name"></span><br />
          Branch URL:
          <a
            :href="'https://github.com/wtsi-hgi/spack-repo/tree/' + (apiResults.prResult && apiResults.prResult.branch_name)"
            target="_blank"
            style="color: #333; text-decoration: underline"
            x-text="'https://github.com/wtsi-hgi/spack-repo/tree/' + (apiResults.prResult && apiResults.prResult.branch_name)"
          ></a
          ><br />
        </div>

        <div x-show="apiResults.prResult && !apiResults.prResult.success" class="warning-box">
          <strong>❌ Pull Request Preparation Failed</strong><br />
          Error:
          <span x-text="apiResults.prResult && apiResults.prResult.message"></span>
          <div
            x-show="apiResults.prResult && apiResults.prResult.git_commands"
            style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-family: monospace; font-size: 12px"
          >
            <strong>Git Commands Executed:</strong><br />
            <template x-for="(command, index) in apiResults.prResult && apiResults.prResult.git_commands" :key="index">
              <div style="margin: 2px 0" x-text="command"></div>
            </template>
          </div>
        </div>

        <div class="warning-box">
          <strong>⚠️ Important: Collaborator Access Required</strong><br />
          To create a pull request, you need collaborator access to the spack-repo repository.
          <br /><br />
          <strong>Do you have collaborator access?</strong>
          <div class="radio-group" style="margin-top: 10px">
            <button
              type="button"
              class="btn"
              :class="{ 'btn-success': hasCollaboratorAccess === 'yes', 'btn-secondary': hasCollaboratorAccess !== 'yes' }"
              @click="hasCollaboratorAccess = 'yes'"
            >
              Yes, I have access
            </button>
            <button
              type="button"
              class="btn"
              :class="{ 'btn-success': hasCollaboratorAccess === 'no', 'btn-secondary': hasCollaboratorAccess !== 'no' }"
              @click="hasCollaboratorAccess = 'no'"
            >
              No, I need to request access
            </button>
          </div>

          <!-- Access Request Form -->
          <div x-show="hasCollaboratorAccess === 'no'" style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px">
            <strong>Request Collaborator Access</strong><br /><br />
            Please provide your GitHub username to request access to the spack-repo:

            <div class="input-group" style="margin-top: 15px">
              <label for="githubUsername">GitHub Username:</label>
              <input
                type="text"
                id="githubUsername"
                x-model="githubUsername"
                placeholder="e.g., johndoe"
                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px"
              />
            </div>

            <button class="btn btn-warning" @click="requestCollaboratorAccess()" :disabled="!githubUsername.trim() || apiStates.requestingAccess" style="margin-top: 10px">
              <span x-show="!apiStates.requestingAccess">Request Access</span>
              <span x-show="apiStates.requestingAccess">Sending Request...</span>
            </button>

            <div x-show="apiResults.accessRequestResult" style="margin-top: 15px">
              <div x-show="apiResults.accessRequestResult && apiResults.accessRequestResult.success" class="success-box" style="margin: 0">
                <strong>✅ Access Request Sent Successfully!</strong><br />
                An email has been sent to HGI Service Desk requesting collaborator access for
                <strong x-text="githubUsername"></strong>. <br /><br />
                Once your access is granted, we will proceed with creating your pull request. You can create any future pull requests on your own.
              </div>
              <div x-show="apiResults.accessRequestResult && !apiResults.accessRequestResult.success" class="warning-box" style="margin: 0">
                <strong>❌ Access Request Failed</strong><br />
                Error:
                <span x-text="apiResults.accessRequestResult && apiResults.accessRequestResult.message"></span>
                <br /><br />
                Please contact HGI Service Desk directly at hgi@sanger.ac.uk
              </div>
            </div>
          </div>

          <!-- Proceed with PR creation -->
          <div x-show="hasCollaboratorAccess === 'yes'" style="margin-top: 20px">
            <div class="success-box" style="margin: 0">✅ Great! You have collaborator access. You can proceed with creating the pull request.</div>
          </div>
        </div>

        <div x-show="apiResults.prResult && apiResults.prResult.success && hasCollaboratorAccess === 'yes'" class="success-box">
          <strong>Next step:</strong> Click the link below to create the pull request on GitHub<br />
          <br />
          <a :href="apiResults.prResult && apiResults.prResult.pr_url" target="_blank" class="btn btn-success" style="display: inline-block; text-decoration: none; margin-top: 10px">
            🚀 Create Pull Request on GitHub
          </a>
          <br /><br />
          <small style="color: #666">Or copy this URL: <code x-text="apiResults.prResult && apiResults.prResult.pr_url"></code></small>
        </div>

        <div class="warning-box" x-show="hasCollaboratorAccess === 'yes'">
          <strong>Final Steps:</strong><br />
          1. Click the "Create Pull Request" button above<br />
          2. Review the changes on GitHub<br />
          3. Wait for GitHub Actions validation<br />
          4. Address any review comments<br />
          5. Merge when approved!
        </div>
      </div>

      <!-- Navigation -->
      <div x-show="sessionId" class="navigation" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <button
            class="btn btn-secondary"
            @click="previousStep()"
            :disabled="currentStep === 1"
            x-show="currentStep > 1"
          >
            Previous
          </button>
        </div>

        <button
          class="btn"
          :class="!canProceed() ? 'btn-disabled' : ''"
          @click="currentStep === totalSteps ? clearAllStates() : nextStep()"
          :disabled="!canProceed() || apiStates.creatingRecipe || apiStates.autoCreatingRecipe"
          :title="currentStep === 1 && step1ValidationAttempted && (!packageName.trim() || !packageType) ? 'Please fill in both package name and package type to continue' :
                 currentStep === 3 && validationResult && !validationResult.is_valid ? 'Please fix recipe validation errors before proceeding' : ''"
        >
          <span x-show="!apiStates.creatingRecipe && !apiStates.autoCreatingRecipe" x-text="currentStep === totalSteps ? 'Add Another Package' : 'Next'"></span>
          <span x-show="apiStates.creatingRecipe">Processing...</span>
          <span x-show="apiStates.autoCreatingRecipe">Creating Recipe...</span>
        </button>
      </div>

      <!-- Debug Session Info -->
      <div x-show="sessionId" style="position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #999; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 3px">
        Session: <span x-text="sessionId"></span>
      </div>
    </div>
  </body>
</html>
